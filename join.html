<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat • Check-in</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233;}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea;}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:700}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    #map{height:360px}
  </style>
  <!-- Google Maps -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZZD33JtcrbvN-THBixRMhPdvc9m8tT9s&libraries=geometry&callback=initJoin">
  </script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
    <div class="font-extrabold text-xl">GeoChat</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="index.html" class="chip px-3 py-1.5 rounded-lg">Home</a>
    <a href="create.html" class="chip px-3 py-1.5 rounded-lg">Crea</a>
    <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
  </nav>
</header>

<main class="max-w-3xl mx-auto px-4 pb-20">
  <div class="glass rounded-2xl p-5">
    <h1 id="roomName" class="text-2xl font-extrabold mb-1"></h1>
    <a id="roomAddr" class="underline opacity-90" target="_blank"></a>

    <div id="map" class="rounded-xl overflow-hidden my-4"></div>

    <div id="stateLine" class="text-lg font-bold">In attesa della tua posizione…</div>

    <div class="mt-6 glass rounded-xl p-4">
      <p class="opacity-90">Per entrare devi essere <b>dentro</b> al perimetro del locale.</p>
      <div class="mt-3 flex items-center gap-3">
        <button id="btnEnter" class="btn-main rounded-lg px-5 py-2 opacity-50 cursor-not-allowed">Entra nella chat</button>
        <button id="btnRefresh" class="chip rounded-lg px-4 py-2">Aggiorna posizione</button>
        <a href="index.html" class="chip rounded-lg px-4 py-2">Torna alla Home</a>
      </div>
    </div>
  </div>
</main>

<script>
  const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  let map, poly, meMarker, roomId, inside=false, hasFix=false, room;

  // eseguita dal callback di Google Maps
  window.initJoin = async function(){
    const p = new URLSearchParams(location.search);
    roomId = p.get('room');
    if (!roomId){ location.replace('index.html'); return; }

    // auth link
    (async ()=>{
      const { data:{session} } = await sb.auth.getSession();
      const el = document.getElementById('authLink');
      if (session){ el.textContent='Esci'; el.onclick=async(e)=>{e.preventDefault(); await sb.auth.signOut(); location.href='index.html'} }
      else { el.textContent='Entra'; el.href='auth.html'; }
    })();

    // fetch stanza
    const { data, error } = await sb.from('rooms').select('*').eq('id',roomId).single();
    if (error || !data){ alert('Stanza non trovata.'); location.replace('index.html'); return; }
    room = data;

    document.getElementById('roomName').textContent = room.name || 'Chat locale';
    document.getElementById('roomAddr').textContent = room.address || '';
    document.getElementById('roomAddr').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(room.address|| (room.center_lat+','+room.center_lng))}`;

    map = new google.maps.Map(document.getElementById('map'),{
      center:{lat:room.center_lat, lng:room.center_lng}, zoom:18, streetViewControl:false
    });

    // Poligono
    const path = (room.polygon?.coordinates?.[0]||[]).map(([lng,lat])=>({lat,lng}));
    poly = new google.maps.Polygon({
      paths:path, map, fillColor:'#00ff80', fillOpacity:.25, strokeColor:'#00ff80'
    });

    // Richiedi posizione (fn riutilizzabile)
    const askPosition = ()=>{
      document.getElementById('stateLine').textContent='Verifico la tua posizione…';
      navigator.geolocation.getCurrentPosition(
        pos => {
          hasFix = true;
          const my = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          if (meMarker) meMarker.setMap(null);
          meMarker = new google.maps.Marker({position:my, map, animation:'DROP'});
          inside = google.maps.geometry.poly.containsLocation(new google.maps.LatLng(my.lat,my.lng), poly);
          document.getElementById('stateLine').innerHTML = inside
            ? 'Sei dentro al perimetro ✅'
            : 'Sei fuori dal perimetro ❌';
          // abilita bottone
          const btn = document.getElementById('btnEnter');
          btn.classList.remove('opacity-50','cursor-not-allowed');
        },
        _ => {
          hasFix = false;
          inside = false;
          document.getElementById('stateLine').innerHTML='Posizione non disponibile ❔';
        },
        { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
      );
    };

    askPosition();
    document.getElementById('btnRefresh').onclick = askPosition;

    // Entra nella chat: CONSENTITO SOLO se ho fix e sono dentro
    document.getElementById('btnEnter').onclick = ()=>{
      if (!hasFix){ alert('Posizione non disponibile. Attiva la geolocalizzazione.'); return; }
      if (!inside){ alert('Devi essere DENTRO al perimetro per entrare.'); return; }
      location.href = `chat.html?room=${encodeURIComponent(roomId)}`;
    };
  }
</script>
</body>
</html>
