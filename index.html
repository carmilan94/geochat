<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat ‚Ä¢ Supabase + Google Maps</title>

  <!-- Tailwind (ok anche da CDN per MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    #gmap, #joinMap { height: 420px; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    .gm-control-btn { background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); padding:6px 10px; margin-right:6px; font-size:12px; cursor:pointer; }
    .gm-control-btn[disabled] { opacity:.5; cursor:not-allowed; }
  </style>
  <link rel="icon" href="data:,"> <!-- evita 404 favicon -->
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">GC</div>
        <h1 class="text-xl font-bold">GeoChat</h1>
        <span class="ml-2 text-sm text-slate-500">Supabase + Google Maps</span>
      </div>
      <nav class="text-sm flex items-center gap-4">
        <a href="#" id="navCreate" class="font-medium text-slate-700 hover:text-slate-900">Crea chat</a>
        <a href="#" id="navJoin" class="text-slate-500 hover:text-slate-900">Entra</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- CREATE -->
    <section id="createSection" class="space-y-6">
      <div class="grid md:grid-cols-5 gap-4">
        <div class="md:col-span-3 bg-white rounded-2xl shadow p-4">
          <h2 class="text-lg font-semibold mb-3">1) Cerca indirizzo/attivit√† & disegna il perimetro</h2>

          <div class="flex gap-2 mb-3">
            <input id="venueName" type="text" placeholder="Nome del locale (es. Bar Centrale)" class="w-1/3 px-3 py-2 border rounded-lg focus:outline-none focus:ring" />
            <input id="addressInput" type="text" placeholder="Indirizzo o attivit√† (es. 'Pizzeria Da Mario' o 'Via Roma 10, Napoli')" class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring" autocomplete="off" />
            <button id="btnSearch" class="px-4 py-2 rounded-lg bg-slate-900 text-white">Cerca</button>
          </div>

          <div class="flex items-center gap-3 mb-2">
            <label class="flex items-center gap-2 text-sm text-slate-600">
              Mappa:
              <select id="mapType" class="border rounded-lg px-2 py-1">
                <option value="roadmap">Stradale</option>
                <option value="satellite">Satellite</option>
                <option value="hybrid">Ibrida</option>
                <option value="terrain">Terreno</option>
              </select>
            </label>
          </div>

          <div id="gmap" class="rounded-xl overflow-hidden border"></div>
          <p class="mt-2 text-sm text-slate-600">
            Usa lo strumento <em>poligono</em> (pulsantiera in alto a sinistra) per disegnare l'area.<br/>
            ‚Ä¢ Clic destro su un vertice per rimuoverlo ‚Ä¢ Bottoni: ‚Äú‚úé Modifica‚Äù, ‚ÄúüóëÔ∏è Elimina‚Äù, ‚Äú‚ûï Disegna‚Äù.
          </p>
        </div>

        <div class="md:col-span-2 bg-white rounded-2xl shadow p-4 flex flex-col">
          <h2 class="text-lg font-semibold mb-3">2) Crea la chat & QR</h2>
          <label class="text-sm mb-1">Descrizione (opzionale)</label>
          <textarea id="venueDesc" class="w-full h-24 px-3 py-2 border rounded-lg focus:outline-none focus:ring" placeholder="Es. Chat del Bar Centrale solo per chi √® dentro il locale"></textarea>

          <button id="btnCreate" class="mt-3 px-4 py-2 rounded-lg bg-emerald-600 text-white disabled:opacity-50">Crea chat</button>

          <div id="createResult" class="hidden mt-4">
            <div class="text-sm text-slate-600">Link di accesso:</div>
            <div class="flex items-center gap-2 mt-1">
              <input id="joinLink" readonly class="flex-1 px-3 py-2 border rounded-lg" />
              <button id="btnCopyLink" class="px-3 py-2 rounded-lg border">Copia</button>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-3 items-start">
              <div>
                <div id="qrcode" class="p-3 rounded-xl border bg-white inline-block"></div>
                <div class="mt-2">
                  <button id="btnDownloadQR" class="px-3 py-2 rounded-lg border">Scarica QR</button>
                </div>
              </div>
              <div class="text-sm text-slate-600">
                <p><strong>Istruzioni:</strong></p>
                <ol class="list-decimal ml-4 space-y-1">
                  <li>Stampa il QR e mettilo all'ingresso.</li>
                  <li>Chi lo scansiona entra se √® dentro il perimetro.</li>
                  <li>Uscendo dal perimetro viene disconnesso.</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- JOIN -->
    <section id="joinSection" class="hidden space-y-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 id="roomTitle" class="text-lg font-semibold">Entra nella chat</h2>
            <p id="roomSubtitle" class="text-sm text-slate-600">Scansiona un QR o apri un link con ?room=...</p>
          </div>
          <span id="geoStatus" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">Geolocalizzazione‚Ä¶</span>
        </div>
        <div id="joinMap" class="rounded-xl overflow-hidden border mt-3"></div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 bg-white rounded-2xl shadow p-4 flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Chat</h3>
            <span id="insideBadge" class="text-xs px-2 py-1 rounded-full bg-rose-100 text-rose-700">Fuori area</span>
          </div>
          <div id="messages" class="flex-1 min-h-[240px] max-h-[360px] overflow-y-auto pr-1 scrollbar-thin bg-slate-50 rounded-xl p-3"></div>
          <div class="mt-3 flex gap-2">
            <input id="msgInput" class="flex-1 px-3 py-2 border rounded-lg" placeholder="Scrivi un messaggio‚Ä¶" />
            <button id="btnSend" class="px-4 py-2 rounded-lg bg-slate-900 text-white disabled:opacity-50">Invia</button>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Info stanza</h3>
          <dl class="text-sm text-slate-700 space-y-1">
            <div class="flex justify-between"><dt>Nome</dt><dd id="infoName" class="font-medium text-slate-900">‚Äî</dd></div>
            <div class="flex justify-between"><dt>Indirizzo</dt><dd id="infoAddr">‚Äî</dd></div>
            <div class="flex justify-between"><dt>Creato</dt><dd id="infoCreated" class="whitespace-nowrap">‚Äî</dd></div>
            <div class="flex justify-between"><dt>Utente</dt><dd id="infoUser">‚Äî</dd></div>
          </dl>
        </div>
      </div>
    </section>
  </main>

  <!-- GOOGLE MAPS (Places + Drawing + Geometry) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZZD33JtcrbvN-THBixRMhPdvc9m8tT9s&libraries=places,drawing,geometry&language=it&region=IT"></script>

  <!-- TUTTO IL CODICE IN UN MODULO (import ESM di Supabase) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm";

    /* ====== CONFIG SUPABASE (tuoi valori) ====== */
    const SUPABASE_URL = "https://lkdtvaiwlnkxwvlimvqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8";

    /* ====== Inizializza Supabase ====== */
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ====== Identit√† utente locale ====== */
    let localUserId = localStorage.getItem("geochat_user");
    if (!localUserId) { localUserId = Math.random().toString(36).slice(2, 8); localStorage.setItem("geochat_user", localUserId); }
    const infoUserEl = document.getElementById("infoUser"); if (infoUserEl) infoUserEl.textContent = localUserId;

    /* ====== NAV ====== */
    const createSection = document.getElementById("createSection");
    const joinSection   = document.getElementById("joinSection");
    document.getElementById("navCreate").onclick = (e)=>{ e.preventDefault(); createSection.classList.remove("hidden"); joinSection.classList.add("hidden"); history.replaceState({}, "", location.pathname); };
    document.getElementById("navJoin").onclick   = (e)=>{ e.preventDefault(); createSection.classList.add("hidden");   joinSection.classList.remove("hidden"); initJoin(); };
    const roomParam = new URLSearchParams(location.search).get("room");
    if (roomParam) { createSection.classList.add("hidden"); joinSection.classList.remove("hidden"); }

    /* ====== GOOGLE MAP (CREATE) ====== */
    let map, drawingManager, drawnPolygon = null, marker = null, autocomplete, placesService;
    let btnEdit, btnDelete, btnRedraw;

    function addControlButton(map, position, text, title, onClick){
      const div = document.createElement("div");
      const btn = document.createElement("button");
      btn.className = "gm-control-btn"; btn.type = "button"; btn.textContent = text; btn.title = title;
      btn.addEventListener("click", onClick);
      div.appendChild(btn);
      map.controls[position].push(div);
      return btn;
    }
    function updateControls(){ const hasPoly = !!drawnPolygon; if (btnEdit) btnEdit.disabled=!hasPoly; if (btnDelete) btnDelete.disabled=!hasPoly; }

    function initCreateMap(){
      map = new google.maps.Map(document.getElementById("gmap"), {
        center: { lat: 41.9028, lng: 12.4964 }, zoom: 6, mapTypeId: "roadmap", fullscreenControl: true, streetViewControl: false
      });
      placesService = new google.maps.places.PlacesService(map);

      document.getElementById("mapType").addEventListener("change", function(){ map.setMapTypeId(this.value); });

      // Autocomplete
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("addressInput"),
        { types: ["geocode","establishment"], componentRestrictions: { country: "it" }, fields: ["name","formatted_address","geometry","place_id"] }
      );
      autocomplete.addListener("place_changed", function(){
        const place = autocomplete.getPlace(); if (!place || !place.geometry) return;
        const loc = place.geometry.location;
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: loc, map, title: place.name || place.formatted_address || "" });
        map.setCenter(loc); map.setZoom(18);
      });

      // Bottone Cerca: Text Search
      document.getElementById("btnSearch").onclick = function(){
        const q = document.getElementById("addressInput").value.trim(); if (!q) return;
        placesService.textSearch({ query: q }, function(results, status){
          if (status !== google.maps.places.PlacesServiceStatus.OK || !results?.length) { alert("Nessun risultato"); return; }
          const r = results[0];
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: r.geometry.location, map, title: r.name || r.formatted_address || "" });
          map.setCenter(r.geometry.location); map.setZoom(18);
        });
      };

      // Drawing (poligono)
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,
        drawingControlOptions: { drawingModes: [google.maps.drawing.OverlayType.POLYGON] },
        polygonOptions: { strokeColor:"#2563eb", strokeOpacity:1, strokeWeight:2, fillColor:"#2563eb", fillOpacity:0.2, editable:true }
      });
      drawingManager.setMap(map);

      google.maps.event.addListener(drawingManager, "overlaycomplete", function(e){
        if (e.type === google.maps.drawing.OverlayType.POLYGON) {
          if (drawnPolygon) drawnPolygon.setMap(null);
          drawnPolygon = e.overlay;
          drawingManager.setDrawingMode(null);
          google.maps.event.addListener(drawnPolygon, "rightclick", function(ev){ if (typeof ev.vertex === "number") drawnPolygon.getPath().removeAt(ev.vertex); });
          updateControls();
        }
      });

      // Controlli personalizzati
      btnEdit = addControlButton(map, google.maps.ControlPosition.TOP_LEFT, "‚úé Modifica", "Abilita/Disabilita modifica poligono", function(){
        if (!drawnPolygon) return; const editable = drawnPolygon.getEditable(); drawnPolygon.setEditable(!editable); this.textContent = drawnPolygon.getEditable() ? "‚úì Modifica" : "‚úé Modifica";
      });
      btnDelete = addControlButton(map, google.maps.ControlPosition.TOP_LEFT, "üóëÔ∏è Elimina", "Cancella perimetro", function(){
        if (!drawnPolygon) return; drawnPolygon.setMap(null); drawnPolygon=null; drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON); updateControls();
      });
      btnRedraw = addControlButton(map, google.maps.ControlPosition.TOP_LEFT, "‚ûï Disegna", "Disegna un nuovo perimetro", function(){ drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON); });

      updateControls();
    }

    /* ====== CREA STANZA ====== */
    const btnCreate = document.getElementById("btnCreate");
    const createResult = document.getElementById("createResult");
    const joinLinkInput = document.getElementById("joinLink");
    const qrcodeDiv = document.getElementById("qrcode");

    btnCreate.onclick = async function(){
      const name = document.getElementById("venueName").value.trim() || "Chat del locale";
      const desc = document.getElementById("venueDesc").value.trim();
      const address = document.getElementById("addressInput").value.trim();
      if (!drawnPolygon) { alert("Disegna il perimetro (poligono) prima di creare la chat."); return; }

      // Estrai coord [lng,lat]
      const path = drawnPolygon.getPath(); const coords = [];
      for (let i=0;i<path.getLength();i++){ const ll = path.getAt(i); coords.push([ll.lng(), ll.lat()]); }
      if (coords.length && (coords[0][0]!==coords.at(-1)[0] || coords[0][1]!==coords.at(-1)[1])) coords.push(coords[0]);

      const bounds = new google.maps.LatLngBounds(); for (let j=0;j<path.getLength();j++) bounds.extend(path.getAt(j));
      const center = bounds.getCenter();

      const roomId = Math.random().toString(36).slice(2,10);

      const { error } = await supabase.from("rooms").insert({
        id: roomId, name, description: desc, address,
        polygon: { type:"Polygon", coordinates:[coords] },
        center_lat: center.lat(), center_lng: center.lng(), created_by: localUserId
      });
      if (error) { console.error(error); alert("Errore creazione stanza: " + error.message); return; }

      const joinUrl = location.origin + location.pathname + "?room=" + roomId;
      joinLinkInput.value = joinUrl; createResult.classList.remove("hidden"); qrcodeDiv.innerHTML = "";
      new QRCode(qrcodeDiv, { text: joinUrl, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      document.getElementById("btnCopyLink").onclick = function(){ joinLinkInput.select(); document.execCommand("copy"); };
      document.getElementById("btnDownloadQR").onclick = function(){ const img = qrcodeDiv.querySelector("img")||qrcodeDiv.querySelector("canvas"); if (!img) return; const a=document.createElement("a"); a.download="GeoChat-"+roomId+".png"; a.href=img.src||img.toDataURL(); a.click(); };
    };

    /* ====== JOIN (Supabase + Maps) ====== */
    let joinMap, joinPolygon=null, roomId, roomMeta;
    const geoStatus   = document.getElementById("geoStatus");
    const insideBadge = document.getElementById("insideBadge");
    const messagesEl  = document.getElementById("messages");
    const btnSend     = document.getElementById("btnSend");
    const msgInput    = document.getElementById("msgInput");
    let messagesChannel = null;

    async function initJoin(){
      if (!joinMap) joinMap = new google.maps.Map(document.getElementById("joinMap"), { center:{lat:41.9028,lng:12.4964}, zoom:6, mapTypeId:"roadmap", fullscreenControl:true, streetViewControl:false });
      messagesEl.innerHTML = "";

      const params = new URLSearchParams(location.search); roomId = params.get("room"); if (!roomId) return;

      const { data: room, error } = await supabase.from("rooms").select("*").eq("id", roomId).single();
      if (error || !room) { alert("Stanza non trovata."); return; }
      roomMeta = room;

      document.getElementById("roomTitle").textContent = "Chat: " + (roomMeta.name || "‚Äî");
      document.getElementById("roomSubtitle").textContent = roomMeta.description || "‚Äî";
      document.getElementById("infoName").textContent = roomMeta.name || "‚Äî";
      document.getElementById("infoAddr").textContent = roomMeta.address || "‚Äî";
      document.getElementById("infoCreated").textContent = new Date(roomMeta.created_at).toLocaleString();

      if (joinPolygon) joinPolygon.setMap(null);
      const path = roomMeta.polygon.coordinates[0].map(p => ({ lat: p[1], lng: p[0] }));
      joinPolygon = new google.maps.Polygon({ paths: path, strokeColor:"#334155", strokeWeight:2, strokeOpacity:1, fillColor:"#334155", fillOpacity:0.15, map: joinMap });

      const bounds = new google.maps.LatLngBounds(); path.forEach(pt => bounds.extend(pt)); joinMap.fitBounds(bounds);

      startGeoWatch();
      await loadMessages();
      subscribeRealtime();
    }

    async function loadMessages(){
      const { data, error } = await supabase.from("messages").select("*").eq("room_id", roomId).order("created_at",{ascending:true}).limit(100);
      if (error) { console.error(error); return; }
      messagesEl.innerHTML = ""; (data||[]).forEach(appendMsg); messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function subscribeRealtime(){
      if (messagesChannel) { supabase.removeChannel(messagesChannel); messagesChannel = null; }
      messagesChannel = supabase
        .channel("room_"+roomId)
        .on("postgres_changes", { event:"INSERT", schema:"public", table:"messages", filter:"room_id=eq."+roomId }, (payload)=>appendMsg(payload.new))
        .subscribe();
    }

    function appendMsg(msg){
      const wrap = document.createElement("div"); wrap.className="mb-2";
      const who  = document.createElement("div"); who.className="text-xs text-slate-500";
      const ts   = new Date(msg.created_at || Date.now()).toLocaleTimeString();
      who.textContent = (msg.user_id || "Anon") + " ‚Ä¢ " + ts;
      const bubble = document.createElement("div"); bubble.className="inline-block px-3 py-2 rounded-2xl bg-white shadow border mt-0.5"; bubble.textContent = msg.body;
      wrap.appendChild(who); wrap.appendChild(bubble); messagesEl.appendChild(wrap); messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function startGeoWatch(){
      if (!navigator.geolocation) { geoStatus.textContent="Geolocalizzazione non supportata"; return; }
      geoStatus.textContent="In attesa posizione‚Ä¶";
      function onUpdate(pos){
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        let inside = false;
        if (joinPolygon) inside = google.maps.geometry.poly.containsLocation(new google.maps.LatLng(lat,lng), joinPolygon);
        geoStatus.textContent = inside ? "‚úÖ Dentro l'area" : "‚ùå Fuori area";
        insideBadge.textContent = inside ? "Dentro area" : "Fuori area";
        insideBadge.className = inside ? "text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700" : "text-xs px-2 py-1 rounded-full bg-rose-100 text-rose-700";
        btnSend.disabled = !inside;
      }
      function onError(){ geoStatus.textContent="Posizione non disponibile"; btnSend.disabled=true; }
      navigator.geolocation.watchPosition(onUpdate,onError,{ enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
    }

    btnSend.onclick = async function(){
      const text = msgInput.value.trim(); if (!text || !roomId) return;
      const { error } = await supabase.from("messages").insert({ room_id: roomId, user_id: localUserId, body: text });
      if (!error) msgInput.value = ""; else alert("Errore invio messaggio: " + error.message);
    };
    msgInput.addEventListener("keydown", (e)=>{ if (e.key==="Enter") btnSend.click(); });

    // Boot
    function boot(){ initCreateMap(); if (roomParam) initJoin(); }
    boot();
  </script>
</body>
</html>
