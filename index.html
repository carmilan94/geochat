<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat â€¢ Crea chat geofence</title>

  <!-- Tailwind (ok per MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QRCode lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    #map { height: 460px; }
    .gm-control-btn{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.10); padding:6px 10px; margin-right:6px; font-size:12px; cursor:pointer; }
    .gm-control-btn[disabled]{ opacity:.5; cursor:default; }
    .badgelite{font-size:12px; padding:2px 8px; border-radius:999px;}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

  <!-- topbar -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="text-xl font-bold">GeoChat</div>
        <span class="text-sm text-slate-500">MVP â€¢ Supabase + Google Maps</span>
      </div>

      <nav class="ms-auto flex items-center gap-4">
        <a id="navCreate" href="#" class="text-slate-700 hover:text-slate-900">Crea chat</a>
        <a id="navJoin" href="#" class="text-slate-500 hover:text-slate-900">Entra</a>
        <a href="admin.html" class="text-slate-500 hover:text-slate-900">Admin</a>
      </nav>
    </div>
  </header>

  <!-- APP (nascosta finchÃ© non validiamo la sessione) -->
  <main id="app" class="max-w-6xl mx-auto px-4 py-6 hidden">

    <!-- JOIN strip (spiegazione) -->
    <div id="authStrip" class="mb-4 px-3 py-2 rounded-xl bg-amber-50 text-amber-800 hidden">
      Devi essere registrato per creare o entrare in una chat.
    </div>

    <!-- CREA CHAT -->
    <section id="createSection" class="space-y-6">
      <div class="grid md:grid-cols-3 gap-4">
        <!-- sinistra -->
        <div class="md:col-span-2 bg-white rounded-2xl shadow p-4">
          <h2 class="text-lg font-semibold mb-3">1) Cerca indirizzo/attivitÃ  & disegna il perimetro</h2>

          <div class="flex gap-2 mb-3">
            <input id="inVenueName" type="text" placeholder="Nome del locale (es. Bar Centrale)" class="w-1/3 px-3 py-2 border rounded-lg focus:outline-none focus:ring" />
            <input id="inAddress" type="text" placeholder="Indirizzo (es. 'Pizzeria Da Mario' o 'Via Roma 10, Napoli')" class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring" autocomplete="off"/>
            <button id="btnSearch" class="px-4 rounded-lg bg-slate-900 text-white">Cerca</button>
          </div>

          <div class="flex items-center gap-3 mb-2 text-sm text-slate-600">
            <span class="badgelite bg-slate-100">Strumenti</span>
            <button id="btnDraw"    class="badgelite bg-slate-100 px-3">âœš Disegna</button>
            <button id="btnEdit"    class="badgelite bg-slate-100 px-3">âœŽ Modifica</button>
            <button id="btnDelete"  class="badgelite bg-slate-100 px-3">ðŸ—‘ Elimina</button>
          </div>

          <div id="map" class="rounded-xl overflow-hidden border relative"></div>

          <p class="mt-2 text-sm text-slate-600">
            Disegna un <strong>poligono</strong> intorno al locale. Usa i bottoni in alto a sinistra della mappa.<br/>
            Per rimuovere un vertice: <em>click destro</em> su quel punto.
          </p>
        </div>

        <!-- destra -->
        <div class="md:col-span-1 bg-white rounded-2xl shadow p-4">
          <h3 class="text-lg font-semibold mb-3">2) Dettagli & crea link/QR</h3>

          <label class="block text-sm mb-1">Descrizione (opzionale)</label>
          <textarea id="venueDesc" class="w-full h-28 px-3 py-2 border rounded-lg focus:outline-none focus:ring" placeholder="Es. Chat del Bar Centrale solo per chi Ã¨ dentro il locale"></textarea>

          <button id="btnCreateChat" class="w-full mt-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white">
            Crea chat & genera QR
          </button>

          <div id="resultBox" class="mt-4 hidden">
            <label class="block text-sm mb-1">Link di accesso</label>
            <div class="flex gap-2">
              <input id="chatLink" class="flex-1 px-3 py-2 border rounded-lg bg-slate-50" readonly />
              <button id="btnCopyLink" class="px-3 rounded-lg bg-slate-900 text-white">Copia</button>
            </div>
            <div class="mt-3">
              <div id="qrBox" class="p-2 bg-white inline-block rounded-xl border"></div>
              <button id="btnDownloadQR" class="ml-2 px-3 py-2 rounded-lg bg-slate-100">Scarica QR</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ENTRA -->
    <section id="joinSection" class="hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Entra in una chat</h2>
        <p class="text-sm text-slate-600">
          Apri un link con <code>?room=...</code> oppure scansiona un QR creato da un locale.
        </p>
      </div>
    </section>
  </main>

  <!-- ===============  SCRIPT  =============== -->

  <!-- AUTH-GUARD + Supabase init -->
  <script>
  (async () => {
    const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';

    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Sessione
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      const back = encodeURIComponent(location.href);
      location.href = `/auth.html?redirect=${back}`;
      return;
    }

    // Espongo per gli altri script
    window.supabase = supabase;
    window.currentUser = session.user;

    // Mostra app
    document.getElementById('app')?.classList.remove('hidden');

    // Avvia UI e mappa
    initUi(); // toggle tab ecc.
  })();
  </script>

  <!-- UI: toggle tab, copia link, scarica QR -->
  <script>
  function initUi() {
    const createSection = document.getElementById('createSection');
    const joinSection   = document.getElementById('joinSection');
    const navCreate     = document.getElementById('navCreate');
    const navJoin       = document.getElementById('navJoin');

    function show(tab){
      if(tab==='create'){
        createSection.classList.remove('hidden');
        joinSection.classList.add('hidden');
        navCreate?.classList.add('text-slate-900','font-bold');
        navJoin?.classList.remove('text-slate-900','font-bold');
      }else{
        joinSection.classList.remove('hidden');
        createSection.classList.add('hidden');
        navJoin?.classList.add('text-slate-900','font-bold');
        navCreate?.classList.remove('text-slate-900','font-bold');
      }
      try{ localStorage.setItem('gc_tab', tab);}catch(e){}
    }

    // Avvio su "create" (o riprende preferenza)
    const urlTab = new URL(location.href).searchParams.get('tab');
    const saved  = localStorage.getItem('gc_tab');
    show(urlTab || saved || 'create');

    navCreate?.addEventListener('click', (e)=>{ e.preventDefault(); show('create'); });
    navJoin?.addEventListener('click',   (e)=>{ e.preventDefault(); show('join'); });

    // Copy link
    document.getElementById('btnCopyLink')?.addEventListener('click', () => {
      const val = document.getElementById('chatLink').value;
      navigator.clipboard.writeText(val).then(() => {
        alert('Link copiato!');
      });
    });

    // Download QR
    document.getElementById('btnDownloadQR')?.addEventListener('click', () => {
      const canvas = document.querySelector('#qrBox canvas');
      if (!canvas) return;
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'geochat-qr.png';
      a.click();
    });
  }
  </script>

  <!-- Google Maps (Places + Drawing) -->
  <script>
  let map, geocoder, drawingManager, currentPolygon = null, autocomplete;

  function initMap() {
    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 41.9028, lng: 12.4964 }, // Roma
      zoom: 14,
      mapTypeControl: true,
      streetViewControl: false,
      fullscreenControl: false
    });

    // Autocomplete (campo indirizzo)
    const input = document.getElementById('inAddress');
    autocomplete = new google.maps.places.Autocomplete(input, { types: ['geocode'] });
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (place.geometry && place.geometry.location) {
        map.panTo(place.geometry.location);
        map.setZoom(17);
      }
    });

    // Drawing
    drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: null,
      drawingControl: false,
      polygonOptions: {
        editable: true,
        fillColor: '#22c55e',
        fillOpacity: 0.15,
        strokeColor: '#16a34a',
        strokeWeight: 2
      }
    });
    drawingManager.setMap(map);

    google.maps.event.addListener(drawingManager, 'polygoncomplete', poly => {
      if (currentPolygon) currentPolygon.setMap(null);
      currentPolygon = poly;
    });

    // Bottoni strumenti
    document.getElementById('btnDraw')?.addEventListener('click', () => {
      drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
    });
    document.getElementById('btnEdit')?.addEventListener('click', () => {
      if (currentPolygon) currentPolygon.setEditable(true);
      drawingManager.setDrawingMode(null);
    });
    document.getElementById('btnDelete')?.addEventListener('click', () => {
      if (currentPolygon) { currentPolygon.setMap(null); currentPolygon = null; }
      drawingManager.setDrawingMode(null);
    });

    // Cerca indirizzo via bottone
    document.getElementById('btnSearch')?.addEventListener('click', () => {
      const addr = document.getElementById('inAddress').value.trim();
      if (!addr) return;
      geocoder.geocode({ address: addr }, (res, status) => {
        if (status === 'OK' && res[0]) {
          map.panTo(res[0].geometry.location);
          map.setZoom(17);
        }
      });
    });

    // Crea chat -> salva su Supabase
    document.getElementById('btnCreateChat')?.addEventListener('click', async () => {
      const name = document.getElementById('inVenueName').value.trim();
      const address = document.getElementById('inAddress').value.trim();
      const desc = document.getElementById('venueDesc').value.trim();

      if (!name) { alert('Inserisci un nome locale.'); return; }
      if (!address) { alert('Inserisci un indirizzo/attivitÃ .'); return; }
      if (!currentPolygon) { alert('Disegna un perimetro sulla mappa.'); return; }

      const path = currentPolygon.getPath().getArray();
      if (path.length < 3) { alert('Il poligono deve avere almeno 3 punti.'); return; }

      // GeoJSON Polygon
      const coords = [ path.map(p => [p.lng(), p.lat()]) ];
      // Chiudi poligono se necessario
      const first = coords[0][0], last = coords[0][coords[0].length - 1];
      if (first[0] !== last[0] || first[1] !== last[1]) coords[0].push(first);

      const center = currentPolygon.getBounds().getCenter();

      const id = Math.random().toString(36).slice(2,10); // id breve

      const payload = {
        id,
        name,
        description: desc || null,
        address,
        polygon: { type: 'Polygon', coordinates: coords },
        center_lat: center.lat(),
        center_lng: center.lng(),
        owner_id: window.currentUser?.id || null
      };

      const { data, error } = await window.supabase
        .from('rooms')
        .insert(payload)
        .select('id')
        .single();

      if (error) {
        console.error(error);
        alert('Errore nel salvataggio: ' + error.message);
        return;
      }

      const link = `${location.origin}/?room=${data.id}`;
      document.getElementById('chatLink').value = link;
      document.getElementById('resultBox').classList.remove('hidden');

      // QR
      const qrBox = document.getElementById('qrBox');
      qrBox.innerHTML = '';
      new QRCode(qrBox, { text: link, width: 160, height: 160 });
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });
  }

  // Esporta globale per callback di Google
  window.initMap = initMap;
  </script>

  <!-- Google Maps JS (Places + Drawing + Geometry) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZZD33JtcrbvN-THBixRMhPdvc9m8tT9s&libraries=places,drawing,geometry&callback=initMap"
    async defer></script>

</body>
</html>
