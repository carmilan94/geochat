<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat ‚Ä¢ Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233;}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea;}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:700}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    a,button{outline:0}
  </style>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen">
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
    <div class="font-extrabold text-xl">GeoChat</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="index.html" class="chip px-3 py-1.5 rounded-lg">Home</a>
    <a href="create.html" class="chip px-3 py-1.5 rounded-lg">Crea la tua chat</a>
    <a href="admin.html" class="chip px-3 py-1.5 rounded-lg">Admin</a>
    <a id="authLink" href="auth.html" class="btn-main px-4 py-1.5 rounded-lg">Entra</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto px-4 pb-20">
  <section class="glass rounded-2xl p-5 mb-6">
    <h2 class="text-xl font-bold mb-2">Chat vicino a te</h2>
    <p class="text-sm opacity-80">Vedi le chat disponibili, la distanza e apri le indicazioni con Google Maps.</p>
    <div class="mt-4 flex items-center gap-3">
      <button id="btnGeo" class="chip px-4 py-2 rounded-lg flex items-center gap-2">
        <span>üìç</span><span>Usa la mia posizione</span>
      </button>
      <div id="geoState" class="text-xs opacity-80">Posizione non disponibile (lista non ordinata).</div>
    </div>
  </section>

  <section id="roomsList" class="grid gap-4"></section>
</main>

<script>
  // ---- CONFIG SUPABASE
  const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // 1) Se arrivo con ?room=XXXX reindirizzo SUBITO a join.html
  (function autoRedirectToJoin(){
    const p = new URLSearchParams(location.search);
    const r = p.get('room');
    if (r) location.replace(`join.html?room=${encodeURIComponent(r)}`);
  })();

  // 2) Stato auth: mostra "Esci" se loggato
  async function setAuthLink(){
    const { data: { session } } = await sb.auth.getSession();
    const link = document.getElementById('authLink');
    if (session){
      link.textContent = 'Esci';
      link.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.reload(); }
    } else {
      link.textContent = 'Entra';
      link.href = 'auth.html';
      link.onclick = null;
    }
  }
  setAuthLink();

  // 3) Carico rooms
  let myPos = null;
  document.getElementById('btnGeo').onclick = ()=>{
    navigator.geolocation.getCurrentPosition(
      pos => {
        myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        document.getElementById('geoState').textContent = 'Posizione attiva: le distanze saranno calcolate (se possibile).';
        renderRooms();
      },
      _ => { alert('Impossibile ottenere la posizione.'); }
    );
  }

  async function fetchRooms(){
    const { data, error } = await sb.from('rooms')
      .select('id,name,description,address,center_lat,center_lng,created_at')
      .order('created_at',{ascending:false});
    if (error){ console.error(error); return []; }
    return data || [];
  }

  function distanceKm(a,b){
    const R=6371; const dLat=(b.lat-a.lat)*Math.PI/180; const dLng=(b.lng-a.lng)*Math.PI/180;
    const s1=Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s1));
  }

  async function renderRooms(){
    const cont = document.getElementById('roomsList');
    cont.innerHTML = '<div class="opacity-60">Carico‚Ä¶</div>';
    let rooms = await fetchRooms();

    // se ho posizione, ordino per distanza
    if (myPos){
      rooms = rooms.map(r => ({...r, _dist: distanceKm(myPos,{lat:r.center_lat,lng:r.center_lng}) }))
                   .sort((a,b)=> a._dist-b._dist);
    }

    cont.innerHTML = '';
    if (!rooms.length){
      cont.innerHTML = '<div class="glass rounded-xl p-5 opacity-80">Nessuna stanza trovata.</div>';
      return;
    }

    for (const r of rooms){
      const dTxt = myPos ? `${r._dist.toFixed(1)} km` : 'distanza sconosciuta';
      const card = document.createElement('div');
      card.className='glass rounded-xl p-5 flex flex-col gap-3';
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-lg bg-amber-500 text-black font-bold flex items-center justify-center">GC</div>
            <div>
              <div class="font-bold text-lg">${r.name || 'Senza nome'}</div>
              <div class="text-xs opacity-80">Distanza: ${dTxt}</div>
            </div>
          </div>
          <span class="chip px-3 py-1 rounded-lg text-xs">Attiva</span>
        </div>
        <div class="text-sm opacity-90">${r.address || ''}</div>
        <div class="text-sm opacity-70">${r.description || ''}</div>
        <div class="flex gap-2">
          <a class="btn-main rounded-lg px-4 py-2 text-sm" target="_blank"
             href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(r.center_lat+','+r.center_lng)}">
             Apri in Google Maps
          </a>
          <a class="chip rounded-lg px-4 py-2 text-sm" href="join.html?room=${encodeURIComponent(r.id)}">Apri chat</a>
        </div>
      `;
      cont.appendChild(card);
    }
  }
  renderRooms();
</script>
</body>
</html>
