<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat ‚Ä¢ Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:700}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
    <div class="font-extrabold text-xl">GeoChat</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="create.html" class="chip px-3 py-1.5 rounded-lg">Crea la tua chat</a>
    <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
    <a class="btn" href="profile.html">Profilo</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto px-4 pb-24">
  <div class="glass rounded-2xl p-5 mb-4">
    <h1 class="text-2xl font-extrabold mb-2">Chat vicino a te</h1>
    <p class="opacity-85">Vedi le chat disponibili, la distanza (se concedi la posizione) e apri le indicazioni.</p>
    <div class="mt-3 flex items-center gap-3">
      <button id="btnLocate" class="chip px-4 py-2 rounded-lg">üìç Usa la mia posizione</button>
      <span id="locState" class="opacity-70 text-sm">Posizione non disponibile</span>
    </div>

    <!-- NEW: barra di ricerca citt√† -->
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <input id="cityInput"
             class="chip px-3 py-2 rounded-lg bg-transparent outline-none"
             placeholder="Cerca citt√†‚Ä¶ (es. Napoli)" />
      <button id="btnFilter" class="chip px-3 py-2 rounded-lg">Filtra</button>
      <button id="btnClear" class="chip px-3 py-2 rounded-lg">Rimuovi filtro</button>
      <span id="filterState" class="opacity-70 text-sm"></span>
    </div>
    <!-- /NEW -->
  </div>

  <div id="list" class="grid gap-4"></div>
</main>

<script>
  const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // header auth button
  (async ()=>{
    const { data:{session} } = await sb.auth.getSession();
    const link = document.getElementById('authLink');
    if (session){
      link.textContent = 'Esci';
      link.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.reload(); }
    } else {
      link.textContent = 'Entra';
      link.href = 'auth.html';
    }
  })();

  // helper: se non loggato ‚Üí vai a login con next
  async function requireAuthOrRedirect(nextUrl){
    const { data:{session} } = await sb.auth.getSession();
    if (!session){
      location.href = `auth.html?next=${encodeURIComponent(nextUrl)}`;
      return false;
    }
    return true;
  }

  // stato posizione + filtro citt√†
  let myPos=null;
  let cityFilter=''; // NEW

  loadRooms();

  // carica stanze (con eventuale filtro per citt√†)
  async function loadRooms(){
    const container = document.getElementById('list');
    container.innerHTML = '';

    try{
      // base query
      let query = sb.from('rooms').select('*').order('created_at',{ascending:false}).limit(100);

      // NEW: filtro server-side per city OR address (se la colonna esiste)
      if (cityFilter){
        // tenta filtro lato DB; se fallisce faremo filtro client-side nel catch
        query = query.or(`city.ilike.%${cityFilter}%,address.ilike.%${cityFilter}%`);
      }

      let { data, error } = await query;

      // se l'or fallisce (es. colonna mancante), fai fallback client-side
      if (error && cityFilter){
        // ricarica senza filtro e poi filtra qui
        const resp = await sb.from('rooms').select('*').order('created_at',{ascending:false}).limit(100);
        if (resp.error) throw resp.error;
        data = (resp.data||[]).filter(r=>{
          const city = (r.city||'') + ' ' + (r.address||'');
          return city.toLowerCase().includes(cityFilter.toLowerCase());
        });
      } else if (error) {
        throw error;
      }

      (data||[]).forEach(r=>{
        const dist = (myPos && r.center_lat && r.center_lng)
          ? haversine(myPos.lat,myPos.lng, r.center_lat,r.center_lng).toFixed(1)+' km'
          : 'distanza sconosciuta';

        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address || (r.center_lat+','+r.center_lng))}`;

        const card = document.createElement('div');
        card.className='glass rounded-2xl p-4 flex flex-col gap-3';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-bold text-lg">${escapeHtml(r.name||'Chat')}</div>
            <span class="chip px-3 py-1 rounded-lg text-sm">Attivi ‚Äî</span>
          </div>
          <div class="opacity-80 text-sm">${escapeHtml(r.address||'')}</div>
          <div class="opacity-70 text-sm">Distanza: ${dist}</div>
          <div class="flex items-center gap-2">
            <button class="btn-main px-3 py-2 rounded-lg" data-action="maps" data-url="${mapsUrl}">Apri in Google Maps</button>
            <button class="chip px-3 py-2 rounded-lg" data-action="join" data-room="${r.id}">Apri chat</button>
          </div>
        `;
        container.appendChild(card);
      });

      // NEW: stato filtro
      document.getElementById('filterState').textContent =
        cityFilter ? `Filtro citt√†: "${cityFilter}"` : '';
    } catch(e){
      console.error(e);
      container.innerHTML = `<div class="glass rounded-2xl p-4">Errore nel caricamento. Riprova pi√π tardi.</div>`;
    }
  }

  // bottone posizione
  document.getElementById('btnLocate').onclick = ()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      myPos = { lat:pos.coords.latitude, lng:pos.coords.longitude };
      document.getElementById('locState').textContent = 'Posizione acquisita ‚úÖ';
      loadRooms();
    }, _=>{
      document.getElementById('locState').textContent = 'Posizione non disponibile ‚ùå';
    }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
  };

  // NEW: eventi barra di ricerca citt√†
  document.getElementById('btnFilter').onclick = ()=>{
    const v = document.getElementById('cityInput').value.trim();
    cityFilter = v;
    loadRooms();
  };
  document.getElementById('btnClear').onclick = ()=>{
    cityFilter = '';
    document.getElementById('cityInput').value='';
    loadRooms();
  };
  document.getElementById('cityInput').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      cityFilter = e.target.value.trim();
      loadRooms();
    }
  });
  // /NEW

  // click delegato sui pulsanti
  document.addEventListener('click', async (e)=>{
    const mapsBtn = e.target.closest('[data-action="maps"]');
    if (mapsBtn){
      const url = mapsBtn.getAttribute('data-url');
      if (!await requireAuthOrRedirect(url)) return;
      location.href = url;
      return;
    }
    const joinBtn = e.target.closest('[data-action="join"]');
    if (joinBtn){
      const room = joinBtn.getAttribute('data-room');
      const next = `join.html?room=${encodeURIComponent(room)}`;
      if (!await requireAuthOrRedirect(next)) return;
      location.href = next;
    }
  });

  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function haversine(lat1,lon1,lat2,lon2){
    const R=6371, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
</script>
</body>
</html>
