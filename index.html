<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat ‚Ä¢ Home</title>

  <!-- Tailwind (ok per MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Tema: arancione ‚Üí nero */
    .app-gradient { background: linear-gradient(135deg, #ff7a18 0%, #0b0b0b 55%); }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
  </style>
</head>
<body class="min-h-screen text-slate-100 app-gradient">

  <!-- Topbar -->
  <header class="sticky top-0 z-20 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="text-xl font-bold tracking-wide">GeoChat</div>
      <span class="text-sm text-amber-300/80">Trova le chat vicino a te</span>

      <nav class="ms-auto flex items-center gap-4">
        <a href="/" class="text-slate-200 hover:text-white">Home</a>
        <a href="/create.html" class="px-3 py-1 rounded-lg bg-amber-500 hover:bg-amber-400 text-black font-medium">Crea la tua chat</a>
        <a href="/admin.html" class="text-slate-200/80 hover:text-white">Admin</a>

        <span id="userEmail" class="hidden text-sm text-slate-300 ml-3"></span>
        <button id="btnLogout" class="hidden ml-2 px-3 py-1 rounded-lg bg-slate-900/70 hover:bg-slate-900">
          Esci
        </button>
      </nav>
    </div>
  </header>

  <!-- Contenuto -->
  <main id="app" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <!-- Hero -->
    <section class="mb-6">
      <div class="glass rounded-2xl p-6">
        <h1 class="text-2xl font-semibold">Chat vicino a te</h1>
        <p class="text-slate-300 mt-1">
          Vedi le chat disponibili, la distanza dalla tua posizione e apri le indicazioni con Google Maps.
        </p>

        <div class="mt-4 flex items-center gap-3">
          <button id="btnUseGps" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
            üìç Usa la mia posizione
          </button>
          <span id="gpsStatus" class="text-sm text-amber-200/90"></span>
        </div>
      </div>
    </section>

    <!-- Lista -->
    <section id="listSection" class="space-y-4"></section>

    <!-- empty state -->
    <template id="tplEmpty">
      <div class="glass rounded-2xl p-6 text-center text-slate-200">
        Nessuna chat trovata. Crea la tua chat oppure riprova pi√π tardi.
      </div>
    </template>

    <!-- card -->
    <template id="tplCard">
      <div class="glass rounded-2xl p-5 flex items-start gap-4">
        <div class="shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-amber-600 text-black grid place-items-center font-bold">
          GC
        </div>
        <div class="grow">
          <div class="flex items-center gap-2 flex-wrap">
            <h3 class="text-lg font-semibold"></h3>
            <span class="text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10">Attivi: <b class="online">‚Äî</b></span>
            <span class="text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10 distBadge">‚ãØ</span>
          </div>
          <p class="text-sm text-slate-300 mt-1 address"></p>
          <p class="text-sm text-slate-300 mt-1 desc hidden"></p>

          <div class="mt-3 flex items-center gap-2">
            <a class="openMaps px-3 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 text-black font-medium"
               target="_blank" rel="noopener">Apri in Google Maps</a>
            <a class="openRoom px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20"
               target="_blank" rel="noopener">Apri chat</a>
          </div>
        </div>
      </div>
    </template>
  </main>

  <!-- ===============  SCRIPT  =============== -->

  <!-- Supabase + Auth guard -->
  <script>
  (async () => {
    const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';

    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Auth guard
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      const back = encodeURIComponent(location.href);
      location.href = `/auth.html?redirect=${back}`;
      return;
    }

    // Mostra email + logout
    const emailSpan = document.getElementById('userEmail');
    const btnLogout = document.getElementById('btnLogout');
    emailSpan.textContent = session.user.email || '';
    emailSpan.classList.remove('hidden');
    btnLogout.classList.remove('hidden');
    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.href = '/auth.html';
    });

    document.getElementById('app').classList.remove('hidden');

    // Stato utente & funzioni utili a livello globale
    window.supabase = supabase;
    window.currentUser = session.user;

    initHome();
  })();

  // ---------- HOME ----------
  async function initHome() {
    const listEl = document.getElementById('listSection');
    const tplCard = document.getElementById('tplCard');
    const tplEmpty = document.getElementById('tplEmpty');
    const gpsStatus = document.getElementById('gpsStatus');

    let userPos = null;

    const formatDist = (m) => {
      if (m == null) return 'distanza sconosciuta';
      if (m < 1000) return `${Math.round(m)} m`;
      return `${(m/1000).toFixed(1)} km`;
    };

    const haversine = (lat1, lon1, lat2, lon2) => {
      const R = 6371000;
      const toRad = (deg) => deg * Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    };

    async function loadRooms() {
      listEl.innerHTML = '';
      gpsStatus.textContent = 'Caricamento‚Ä¶';

      const { data: rooms, error } = await window.supabase
        .from('rooms')
        .select('id, name, address, description, center_lat, center_lng, created_at')
        .order('created_at', { ascending: false })
        .limit(200);

      if (error) {
        gpsStatus.textContent = 'Errore nel caricamento.';
        console.error(error);
        return;
      }

      if (!rooms || rooms.length === 0) {
        listEl.appendChild(tplEmpty.content.cloneNode(true));
        gpsStatus.textContent = '';
        return;
      }

      // calcola distanze
      let enriched = rooms.map(r => {
        let dist = null;
        if (userPos) dist = haversine(userPos.lat, userPos.lng, r.center_lat, r.center_lng);
        return { ...r, _dist: dist };
      });

      // ordina per distanza se disponibile
      enriched.sort((a,b) => {
        if (a._dist == null && b._dist == null) return 0;
        if (a._dist == null) return 1;
        if (b._dist == null) return -1;
        return a._dist - b._dist;
      });

      // render
      for (const r of enriched) {
        const node = tplCard.content.cloneNode(true);
        node.querySelector('h3').textContent = r.name || 'Senza nome';
        node.querySelector('.address').textContent = r.address || 'Indirizzo non disponibile';

        if (r.description) {
          const d = node.querySelector('.desc');
          d.textContent = r.description;
          d.classList.remove('hidden');
        }

        node.querySelector('.distBadge').textContent = `Distanza: ${formatDist(r._dist)}`;

        const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(r.center_lat+','+r.center_lng)}&travelmode=walking`;
        node.querySelector('.openMaps').href = gmapsUrl;

        const roomUrl = `${location.origin}/?room=${r.id}`;
        node.querySelector('.openRoom').href = roomUrl;

        listEl.appendChild(node);
      }

      gpsStatus.textContent = userPos ? 'Posizione rilevata.' : 'Posizione non disponibile (lista non ordinata).';
    }

    // GPS
    async function askGps() {
      gpsStatus.textContent = 'Richiesta posizione‚Ä¶';
      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            gpsStatus.textContent = 'Posizione aggiornata ‚úÖ';
            resolve(true);
          },
          () => {
            userPos = null;
            gpsStatus.textContent = 'Permesso negato o errore GPS.';
            resolve(false);
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    document.getElementById('btnUseGps').addEventListener('click', async () => {
      await askGps();
      loadRooms();
    });

    // primo caricamento senza GPS (ordina per data)
    await loadRooms();
  }
  </script>

</body>
</html>
