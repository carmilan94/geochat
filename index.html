<script type="module">
/* =======================
   CONFIG SUPABASE
======================= */
const SUPABASE_URL = "https://lkdtvaiwlnkxwvlimvqs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8";

const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =======================
   DOM HOOKS
======================= */
const homeSection  = document.getElementById('homeSection');   // lista stanze
const joinSection  = document.getElementById('joinSection');   // vista join/chat
const btnUseGps    = document.getElementById('btnUseGps');     // “Usa la mia posizione”
const cardsWrap    = document.getElementById('roomsWrap');     // container card
const joinTitle    = document.getElementById('joinTitle');
const joinAddr     = document.getElementById('joinAddr');
const joinMsg      = document.getElementById('joinMsg');
const joinEnterBtn = document.getElementById('joinEnterBtn');  // Entra nella chat
const joinMapEl    = document.getElementById('joinMap');       // mappa join

/* =======================
   STATE
======================= */
let currentPos = null;     // {lat, lng}
let currentRoom = null;    // record stanza
let joinMap, joinPolygon, joinMarker;

/* =======================
   GEO UTILS
======================= */
function getPositionOnce() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocalizzazione non disponibile'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => resolve({
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      }),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  });
}

function pointInPolygon(point, polygonLatLngs) {
  // ray-casting semplice su array [{lat,lng},...]
  let x = point.lng, y = point.lat;
  let inside = false;
  for (let i = 0, j = polygonLatLngs.length - 1; i < polygonLatLngs.length; j = i++) {
    let xi = polygonLatLngs[i].lng, yi = polygonLatLngs[i].lat;
    let xj = polygonLatLngs[j].lng, yj = polygonLatLngs[j].lat;
    let intersect = ((yi > y) !== (yj > y)) &&
                    (x < (xj - xi) * (y - yi) / (yj - yi + 0.0000001) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

/* =======================
   HOME: carica elenco stanze
======================= */
async function loadRooms() {
  // ordina per created_at desc
  const { data, error } = await supabase
    .from('rooms')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) {
    console.error(error);
    cardsWrap.innerHTML = `<div class="text-red-400 text-sm">Errore nel caricamento: ${error.message}</div>`;
    return;
  }

  cardsWrap.innerHTML = '';
  data.forEach(r => {
    const card = document.createElement('div');
    card.className = 'rounded-xl bg-[#141414] border border-white/10 p-4 mb-4 flex items-start gap-4';
    card.innerHTML = `
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-600 text-black font-extrabold grid place-items-center">GC</div>
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-white">${escapeHtml(r.name || 'Senza nome')}</h3>
          <span class="text-xs text-white/50 px-2 py-0.5 rounded bg-white/10">Attiva</span>
        </div>
        <div class="text-xs text-white/60 mt-2">Distanza: <span class="room-dist">sconosciuta</span></div>
        <div class="text-sm text-white/80 mt-1">${escapeHtml(r.address || '')}</div>
        ${r.description ? `<div class="text-xs text-white/60 mt-1">${escapeHtml(r.description)}</div>` : ''}
        <div class="mt-3 flex gap-2">
          <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(r.address || `${r.center_lat},${r.center_lng}`)}"
             class="px-3 py-2 rounded-md bg-amber-500/90 hover:bg-amber-500 text-black text-sm">Apri in Google Maps</a>
          <button class="px-3 py-2 rounded-md bg-white/10 hover:bg-white/15 text-white text-sm"
                  data-open-room="${r.id}">Apri chat</button>
        </div>
      </div>
    `;
    // aggiorna distanza se abbiamo la posizione
    if (currentPos) {
      const km = haversineKm(currentPos, { lat: r.center_lat, lng: r.center_lng });
      card.querySelector('.room-dist').textContent = `${km.toFixed(1)} km`;
    }
    cardsWrap.appendChild(card);
  });
}

/* distanza in km */
function haversineKm(a, b) {
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const s1 = Math.sin(dLat/2) ** 2 +
             Math.cos(a.lat * Math.PI/180) * Math.cos(b.lat * Math.PI/180) *
             (Math.sin(dLng/2) ** 2);
  return 2 * R * Math.asin(Math.sqrt(s1));
}

/* =======================
   JOIN: visualizza stanza e geofence
======================= */
async function openJoin(roomId) {
  // toggle viste
  homeSection.classList.add('hidden');
  joinSection.classList.remove('hidden');

  // carica stanza
  const { data, error } = await supabase.from('rooms').select('*').eq('id', roomId).single();
  if (error || !data) {
    joinTitle.textContent = "Chat non trovata";
    joinAddr.textContent  = "";
    joinMsg.textContent   = error ? error.message : "L'ID della chat non esiste.";
    joinEnterBtn.disabled = true;
    return;
  }
  currentRoom = data;

  joinTitle.textContent = data.name || 'Chat';
  joinAddr.textContent  = data.address || '';
  joinMsg.textContent   = "Verifico la tua posizione...";
  joinEnterBtn.disabled = true;
  joinEnterBtn.dataset.room = data.id;

  // mappa
  if (!window.google || !window.google.maps) {
    joinMsg.textContent = "Mappe non disponibili.";
    return;
  }
  if (!joinMap) {
    joinMap = new google.maps.Map(joinMapEl, {
      center: { lat: data.center_lat, lng: data.center_lng },
      zoom: 17,
      mapId: "geochat-join"
    });
  } else {
    joinMap.setCenter({ lat: data.center_lat, lng: data.center_lng });
    joinMap.setZoom(17);
  }

  // marker (centro locale)
  if (joinMarker) joinMarker.setMap(null);
  joinMarker = new google.maps.Marker({
    position: { lat: data.center_lat, lng: data.center_lng },
    map: joinMap
  });

  // poligono
  if (joinPolygon) joinPolygon.setMap(null);
  const coords = (data.polygon?.coordinates?.[0] || [])
    .map(([lng, lat]) => ({ lat, lng }));
  if (coords.length > 2) {
    joinPolygon = new google.maps.Polygon({
      paths: coords,
      strokeColor: "#22c55e",
      strokeOpacity: 0.9,
      strokeWeight: 2,
      fillColor: "#22c55e",
      fillOpacity: 0.15,
      map: joinMap
    });
  }

  // prova geoloc
  try {
    currentPos = await getPositionOnce();
  } catch(e) {
    joinMsg.textContent = "Posizione non disponibile. Abilita la posizione per poter entrare.";
    joinEnterBtn.disabled = true;
    return;
  }

  // check perimetro
  let canEnter = true;
  if (coords.length > 2) {
    canEnter = pointInPolygon({ lat: currentPos.lat, lng: currentPos.lng }, coords);
  }
  if (canEnter) {
    joinMsg.textContent = "Sei dentro al perimetro ✅";
    joinEnterBtn.disabled = false;
  } else {
    joinMsg.textContent = "Sei fuori dal perimetro ❌";
    joinEnterBtn.disabled = true;
  }
}

/* =======================
   ROUTER
======================= */
function handleRoute() {
  const roomId = new URLSearchParams(location.search).get('room');
  if (roomId) {
    openJoin(roomId);
  } else {
    // Home
    joinSection.classList.add('hidden');
    homeSection.classList.remove('hidden');
    loadRooms(); // ricarico lista
  }
}
window.addEventListener('popstate', handleRoute);

/* =======================
   EVENTS
======================= */
// Usa la mia posizione → calcola distanze e riordina
btnUseGps?.addEventListener('click', async () => {
  try {
    currentPos = await getPositionOnce();
    // ricarico l’elenco con distanze
    await loadRooms();
    // ordina per distanza (grezza: ri-render)
    const cards = [...cardsWrap.children];
    cards.sort((a, b) => {
      const ta = a.querySelector('.room-dist')?.textContent || '';
      const tb = b.querySelector('.room-dist')?.textContent || '';
      const va = parseFloat(ta) || 1e9;
      const vb = parseFloat(tb) || 1e9;
      return va - vb;
    });
    cardsWrap.replaceChildren(...cards);
    document.getElementById('geoHint').textContent = "Posizione attiva (lista ordinata)";
  } catch (e) {
    document.getElementById('geoHint').textContent = "Posizione non disponibile (lista non ordinata)";
  }
});

// delega bottone “Apri chat” sulle card
cardsWrap.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-open-room]');
  if (!btn) return;
  const roomId = btn.getAttribute('data-open-room');
  // navigo con il param (funziona anche da QR)
  location.assign('/?room=' + encodeURIComponent(roomId));
});

// bottone “Entra nella chat”
joinEnterBtn?.addEventListener('click', () => {
  const id = joinEnterBtn.dataset.room;
  if (!id) return;
  // QUI: vai alla pagina della chat vera e propria (separata)
  // Se la tua chat è su chat.html:
  location.assign('/chat.html?room=' + encodeURIComponent(id));
});

/* =======================
   HELPERS
======================= */
function escapeHtml(s='') {
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* =======================
   BOOT
======================= */
document.addEventListener('DOMContentLoaded', () => {
  handleRoute();   // entra in Home o Join a seconda di ?room
  loadRooms();     // prima lista (senza distanze)
});
</script>
