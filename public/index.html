<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat ‚Ä¢ Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:700}
    .disabled{opacity:.5;cursor:not-allowed}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
    <div class="font-extrabold text-xl">GeoChat</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="create.html" class="chip px-3 py-1.5 rounded-lg">Crea la tua chat</a>
    <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
    <a class="btn" href="profile.html">Profilo</a>
  </nav>
</header>

<main class="max-w-4xl mx-auto px-4 pb-24">
  <div class="glass rounded-2xl p-5 mb-4">
    <h1 class="text-2xl font-extrabold mb-2">Chat vicino a te</h1>
    <p class="opacity-85">Vedi le chat disponibili, la distanza (se concedi la posizione) e apri le indicazioni.</p>

    <!-- toolbar posizione + ordinamento -->
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <button id="btnLocate" class="chip px-4 py-2 rounded-lg">üìç Usa la mia posizione</button>
      <span id="locState" class="opacity-70 text-sm">Posizione non disponibile</span>

      <!-- ‚¨áÔ∏è QUI il bottone di ordinamento -->
      <button id="btnSort" class="chip px-3 py-2 rounded-lg disabled" title="Richiede la posizione">
        Ordina per distanza (vicino‚Üílontano)
      </button>
      <span id="sortState" class="opacity-70 text-sm"></span>
    </div>

    <!-- barra ricerca citt√† -->
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <input id="cityInput"
             class="chip px-3 py-2 rounded-lg bg-transparent outline-none"
             placeholder="Cerca citt√†‚Ä¶ (es. Napoli o NA)" />
      <button id="btnFilter" class="chip px-3 py-2 rounded-lg">Filtra</button>
      <button id="btnClear" class="chip px-3 py-2 rounded-lg">Rimuovi filtro</button>
      <span id="filterState" class="opacity-70 text-sm"></span>
    </div>
  </div>

  <div id="list" class="grid gap-4"></div>
</main>

<script>
  const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // auth link
  (async ()=>{
    const { data:{session} } = await sb.auth.getSession();
    const link = document.getElementById('authLink');
    if (session){
      link.textContent = 'Esci';
      link.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.reload(); }
    } else {
      link.textContent = 'Entra';
      link.href = 'auth.html';
    }
  })();

  async function requireAuthOrRedirect(nextUrl){
    const { data:{session} } = await sb.auth.getSession();
    if (!session){
      location.href = `auth.html?next=${encodeURIComponent(nextUrl)}`;
      return false;
    }
    return true;
  }

  let myPos=null;
  let cityFilter='';
  let sortByDistance=false; // stato ordinamento

  // Mappa COMPLETA sigle provincia ‚áÑ nome
  const PROV = {
    "ag":"agrigento","al":"alessandria","an":"ancona","ao":"aosta","ap":"ascoli piceno","aq":"l'aquila","ar":"arezzo","at":"asti","av":"avellino",
    "ba":"bari","bt":"barletta-andria-trani","bl":"belluno","bn":"benevento","bg":"bergamo","bi":"biella","bo":"bologna","bz":"bolzano","bs":"brescia","br":"brindisi",
    "ca":"cagliari","cl":"caltanissetta","cb":"campobasso","ce":"caserta","ct":"catania","cz":"catanzaro","ch":"chieti","co":"como","cs":"cosenza","cr":"cremona","kr":"crotone","cn":"cuneo",
    "en":"enna","fm":"fermo","fe":"ferrara","fi":"firenze","fg":"foggia","fc":"forli-cesena","fr":"frosinone",
    "ge":"genova","go":"gorizia","gr":"grosseto",
    "im":"imperia","is":"isernia",
    "sp":"la spezia","lt":"latina","le":"lecce","lc":"lecco","li":"livorno","lo":"lodi","lu":"lucca",
    "mc":"macerata","mn":"mantova","ms":"massa-carrara","mt":"matera","me":"messina","mi":"milano","mo":"modena","mb":"monza e della brianza",
    "na":"napoli","no":"novara","nu":"nuoro","or":"oristano",
    "pd":"padova","pa":"palermo","pr":"parma","pv":"pavia","pg":"perugia","pu":"pesaro e urbino","pe":"pescara","pc":"piacenza","pi":"pisa","pt":"pistoia","pn":"pordenone","pz":"potenza","po":"prato",
    "rg":"ragusa","ra":"ravenna","rc":"reggio calabria","re":"reggio emilia","ri":"rieti","rn":"rimini","rm":"roma","ro":"rovigo",
    "sa":"salerno","ss":"sassari","sv":"savona","si":"siena","sr":"siracusa","so":"sondrio","su":"sud sardegna",
    "ta":"taranto","te":"teramo","tr":"terni","to":"torino","tp":"trapani","tn":"trento","tv":"treviso","ts":"trieste",
    "ud":"udine",
    "va":"varese","ve":"venezia","vb":"verbano-cusio-ossola","vc":"vercelli","vr":"verona","vv":"vibo valentia","vi":"vicenza","vt":"viterbo"
  };

  const normalize = s => (s||'').toString().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[()]/g,' ');

  function buildAliases(term){
    const t = normalize(term).trim();
    const aliases = new Set([t]);
    for (const [code,name] of Object.entries(PROV)){
      if (t === name) aliases.add(code);
      if (t === code) aliases.add(name);
    }
    return [...aliases];
  }

  function matchesCityOrProvince(room, term){
    const hay = normalize((room.address||'') + ' ' + (room.city||''));
    const aliases = buildAliases(term);
    return aliases.some(a => hay.includes(a));
  }

  // avvio
  loadRooms();

  // carica stanze (con filtro citt√† e ordinamento opzionale per distanza)
  async function loadRooms(){
    const container = document.getElementById('list');
    container.innerHTML = '';

    try{
      let query = sb.from('rooms').select('*').order('created_at',{ascending:false}).limit(100);

      // tenta filtro server-side
      if (cityFilter){
        query = query.or(`city.ilike.%${cityFilter}%,address.ilike.%${cityFilter}%`);
      }
      let { data, error } = await query;

      // fallback senza filtro se errore
      if (error){
        const r = await sb.from('rooms').select('*').order('created_at',{ascending:false}).limit(100);
        if (r.error) throw r.error;
        data = r.data||[];
      }

      // filtro client-side intelligente (nomi‚Üîsigle)
      if (cityFilter){
        data = (data||[]).filter(r => matchesCityOrProvince(r, cityFilter));
      }

      // distanza (se posizione presente)
      data = (data||[]).map(r=>{
        const hasCoords = r.center_lat!=null && r.center_lng!=null;
        let distKm = null;
        if (myPos && hasCoords){
          distKm = haversine(myPos.lat, myPos.lng, Number(r.center_lat), Number(r.center_lng));
        }
        return {...r, _distKm: distKm};
      });

      // ordinamento per distanza
      if (sortByDistance && myPos){
        data.sort((a,b)=>{
          if (a._distKm==null && b._distKm==null) return 0;
          if (a._distKm==null) return 1;
          if (b._distKm==null) return -1;
          return a._distKm - b._distKm;
        });
      }

      // render
      data.forEach(r=>{
        const distTxt = (r._distKm!=null) ? r._distKm.toFixed(1)+' km' : 'distanza sconosciuta';
        const mapsQuery = r.address || ((r.center_lat!=null && r.center_lng!=null) ? `${r.center_lat},${r.center_lng}` : '');
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapsQuery)}`;
        const card = document.createElement('div');
        card.className='glass rounded-2xl p-4 flex flex-col gap-3';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-bold text-lg">${escapeHtml(r.name||'Chat')}</div>
            <span class="chip px-3 py-1 rounded-lg text-sm">Attivi ‚Äî</span>
          </div>
          <div class="opacity-80 text-sm">${escapeHtml(r.address||'')}</div>
          <div class="opacity-70 text-sm">Distanza: ${distTxt}</div>
          <div class="flex items-center gap-2">
            <button class="btn-main px-3 py-2 rounded-lg" data-action="maps" data-url="${mapsUrl}">Apri in Google Maps</button>
            <button class="chip px-3 py-2 rounded-lg" data-action="join" data-room="${r.id}">Apri chat</button>
          </div>
        `;
        container.appendChild(card);
      });

      document.getElementById('filterState').textContent =
        cityFilter ? `Filtro: "${cityFilter}"` : '';

      updateSortButton();
    } catch(e){
      console.error(e);
      container.innerHTML = `<div class="glass rounded-2xl p-4">Errore nel caricamento. Riprova pi√π tardi.</div>`;
    }
  }

  // posizione
  document.getElementById('btnLocate').onclick = ()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      myPos = { lat:pos.coords.latitude, lng:pos.coords.longitude };
      document.getElementById('locState').textContent = 'Posizione acquisita ‚úÖ';
      updateSortButton(true);
      loadRooms();
    }, _=>{
      document.getElementById('locState').textContent = 'Posizione non disponibile ‚ùå';
      updateSortButton(false);
    }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
  };

  // toggle ordinamento per distanza
  document.getElementById('btnSort').onclick = ()=>{
    if (!myPos){
      navigator.geolocation.getCurrentPosition(pos=>{
        myPos = { lat:pos.coords.latitude, lng:pos.coords.longitude };
        document.getElementById('locState').textContent = 'Posizione acquisita ‚úÖ';
        sortByDistance = true;
        updateSortButton(true);
        loadRooms();
      }, _=>{
        document.getElementById('locState').textContent = 'Posizione non disponibile ‚ùå';
        updateSortButton(false);
      }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
      return;
    }
    sortByDistance = !sortByDistance;
    updateSortButton(true);
    loadRooms();
  };

  function updateSortButton(hasPos = !!myPos){
    const btn = document.getElementById('btnSort');
    const state = document.getElementById('sortState');
    if (!hasPos){
      btn.classList.add('disabled');
      state.textContent = 'Ordina per distanza: richiede posizione';
    } else {
      btn.classList.remove('disabled');
      state.textContent = sortByDistance ? 'Ordine: vicino ‚Üí lontano' : 'Ordine: predefinito (pi√π recenti)';
    }
  }

  // barra ricerca citt√†
  document.getElementById('btnFilter').onclick = ()=>{
    cityFilter = document.getElementById('cityInput').value.trim();
    loadRooms();
  };
  document.getElementById('btnClear').onclick = ()=>{
    cityFilter = '';
    document.getElementById('cityInput').value='';
    loadRooms();
  };
  document.getElementById('cityInput').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      cityFilter = e.target.value.trim();
      loadRooms();
    }
  });

  // click delegato sui pulsanti card
  document.addEventListener('click', async (e)=>{
    const mapsBtn = e.target.closest('[data-action="maps"]');
    if (mapsBtn){
      const url = mapsBtn.getAttribute('data-url');
      if (!await requireAuthOrRedirect(url)) return;
      location.href = url;
      return;
    }
    const joinBtn = e.target.closest('[data-action="join"]');
    if (joinBtn){
      const room = joinBtn.getAttribute('data-room');
      const next = `join.html?room=${encodeURIComponent(room)}`;
      if (!await requireAuthOrRedirect(next)) return;
      location.href = next;
    }
  });

  // helpers
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function haversine(lat1,lon1,lat2,lon2){
    const R=6371, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
</script>
</body>
</html>
