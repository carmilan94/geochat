<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMIN ¬∑ Crea la tua chat</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; display:flex; gap:12px; align-items:center; }
    header h1 { font-size: 18px; margin: 0; }
    main { display: grid; grid-template-columns: 340px 1fr; gap: 16px; padding: 16px; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background: #fff; }
    label { display:block; font-size: 13px; margin-bottom: 6px; color:#444; }
    input[type="text"], textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; font-size: 14px; }
    input[type="text"]:focus, textarea:focus { border-color: #111; }
    .muted { color: #666; font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .actions { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background:#111; color:#fff; cursor:pointer; font-weight: 600; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    #map { width: 100%; height: 65vh; border: 1px solid #eee; border-radius: 12px; }
    .ok { color: #0a7b34; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .qr-box { display:none; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#f3f3f3; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="./index.html" class="pill">‚Üê Home</a>
    <h1>Crea la tua chat</h1>
    <span class="muted">Disegna il perimetro e scegli un nome</span>
  </header>

  <main>
    <section class="card" id="formCard">
      <div class="row">
        <!-- RIPRISTINATO: Campo Nome della chat -->
        <div>
          <label for="roomName">Nome della chat <span class="muted">(obbligatorio)</span></label>
          <input type="text" id="roomName" placeholder="Es. IMIN ¬∑ Bar Centrale" maxlength="80" />
        </div>

        <div>
          <label for="roomDesc">Descrizione <span class="muted">(opzionale)</span></label>
          <textarea id="roomDesc" rows="3" placeholder="Descrivi a cosa serve questa chat"></textarea>
        </div>

        <div class="muted">1) Clicca sul pulsante <strong>Disegna</strong> e traccia il poligono. 2) Premi <strong>Salva</strong>.</div>
        <div class="actions">
          <button id="drawBtn" type="button">‚úèÔ∏è Disegna perimetro</button>
          <button id="clearBtn" type="button">üóëÔ∏è Annulla disegno</button>
          <button id="saveBtn" type="button" disabled>üíæ Salva chat</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <hr style="margin:14px 0; border: none; border-top:1px solid #eee;" />
      <div class="row">
        <label>Mappa & perimetro</label>
        <div id="map"></div>
      </div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">QR code</h3>
      <p class="muted">Dopo il salvataggio, genera e scarica il QR per far entrare le persone alla tua chat.</p>
      <div class="actions">
        <button id="qrBtn" type="button" disabled>Genera QR</button>
        <a id="qrDownload" href="#" download style="display:none" class="pill">Scarica PNG</a>
      </div>
      <div class="qr-box" id="qrBox">
        <div id="qrcode"></div>
        <p id="qrLink" class="muted"></p>
      </div>
    </aside>
  </main>

  <footer class="muted" style="padding:12px 16px; border-top:1px solid #eee;">IMIN ¬∑ GeoChat</footer>
</div>

<!-- QRCode lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // üîß Config ‚Äì chiavi inserite
  const SUPABASE_URL  = "https://lkdtvaiwlnkxwvlimvqs.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ‚úÖ Auth gate: se non loggato ‚Üí redirect ad auth.html
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.href = './auth.html?next=create.html';
  })();

  // üåç Google Maps init
  let map, drawingManager, activePolygon = null;
  let savedRoom = null; // conterr√† l'oggetto stanza salvato

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 40.8518, lng: 14.2681 }, // Napoli default
      zoom: 13,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });

    drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: null,
      drawingControl: false,
      polygonOptions: {
        fillOpacity: 0.08,
        strokeWeight: 2,
        clickable: true,
        editable: true,
      }
    });
    drawingManager.setMap(map);

    google.maps.event.addListener(drawingManager, 'overlaycomplete', (e) => {
      if (e.type === google.maps.drawing.OverlayType.POLYGON) {
        if (activePolygon) activePolygon.setMap(null);
        activePolygon = e.overlay;
        drawingManager.setDrawingMode(null);
        updateUIState();
      }
    });
  }

  // Helpers
  function polygonToGeoJSON(polygon) {
    const path = polygon.getPath();
    const coords = [];
    for (let i = 0; i < path.getLength(); i++) {
      const p = path.getAt(i);
      coords.push([p.lng(), p.lat()]);
    }
    if (coords.length && (coords[0][0] !== coords[coords.length-1][0] || coords[0][1] !== coords[coords.length-1][1])) {
      coords.push(coords[0]); // chiudi anello
    }
    return { type: 'Polygon', coordinates: [coords] };
  }

  function updateUIState(msg) {
    const nameOk = !!document.getElementById('roomName').value.trim();
    const polyOk = !!activePolygon;
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = !(nameOk && polyOk);

    const qrBtn = document.getElementById('qrBtn');
    qrBtn.disabled = !savedRoom;

    if (msg) {
      const st = document.getElementById('status');
      st.textContent = msg.text;
      st.className = msg.ok ? 'ok' : 'err';
    }
  }

  // UI handlers
  document.getElementById('drawBtn').addEventListener('click', () => {
    if (activePolygon) { activePolygon.setMap(null); activePolygon = null; }
    drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
    updateUIState();
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    if (activePolygon) { activePolygon.setMap(null); activePolygon = null; }
    updateUIState({ text: 'Perimetro cancellato', ok: true });
  });

  document.getElementById('roomName').addEventListener('input', () => updateUIState());

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const name = document.getElementById('roomName').value.trim();
    const desc = document.getElementById('roomDesc').value.trim();
    if (!name) return updateUIState({ text: 'Inserisci il nome della chat', ok: false });
    if (!activePolygon) return updateUIState({ text: 'Disegna il perimetro sulla mappa', ok: false });

    // valida minimo 3 vertici
    if (activePolygon.getPath().getLength() < 3) return updateUIState({ text: 'Il poligono deve avere almeno 3 punti', ok: false });

    const { data: { user } } = await supabase.auth.getUser();
    const geojson = polygonToGeoJSON(activePolygon);

    const payload = {
      name: name,
      description: desc || null,
      polygon: geojson,
      is_active: true,
      featured: false,
      owner_id: user?.id || null
    };

    const { data, error } = await supabase.from('rooms').insert(payload).select('*').single();
    if (error) {
      console.error(error);
      updateUIState({ text: 'Errore salvataggio: ' + (error.message || 'verifica permessi RLS'), ok: false });
      return;
    }

    savedRoom = data;
    updateUIState({ text: 'Chat salvata! Puoi generare il QR.', ok: true });
  });

  document.getElementById('qrBtn').addEventListener('click', () => {
    if (!savedRoom) return;
    const joinUrl = new URL('./join.html', window.location.href);
    joinUrl.searchParams.set('room', savedRoom.id);

    const box = document.getElementById('qrBox');
    box.style.display = 'block';
    document.getElementById('qrLink').textContent = joinUrl.toString();

    const qrel = document.getElementById('qrcode');
    qrel.innerHTML = '';
    new QRCode(qrel, { text: joinUrl.toString(), width: 220, height: 220 });

    // link download PNG
    const canvas = qrel.querySelector('canvas');
    if (canvas) {
      const a = document.getElementById('qrDownload');
      a.href = canvas.toDataURL('image/png');
      a.download = `imin-qr-${savedRoom.id}.png`;
      a.style.display = 'inline-block';
    }
  });
</script>

<!-- Google Maps JS (Drawing Library) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=LA_TUA_CHIAVE&libraries=drawing&callback=initMap"></script>
</body>
</html>
