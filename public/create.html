<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat • Crea chat (test minimo)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233;}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea;}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:700}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    #map{height:420px}
  </style>
  <!-- Google Maps (ok anche se non usiamo ancora il poligono) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZZD33JtcrbvN-THBixRMhPdvc9m8tT9s&libraries=places,geometry,drawing&callback=initMap"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
    <div class="font-extrabold text-xl">GeoChat</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="index.html" class="chip px-3 py-1.5 rounded-lg">Home</a>
    <a href="create.html" class="btn-main px-3 py-1.5 rounded-lg">Crea la tua chat</a>
    <a href="admin.html" class="chip px-3 py-1.5 rounded-lg">Admin</a>
    <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 pb-24 grid md:grid-cols-3 gap-6">
  <section class="md:col-span-2 glass rounded-2xl p-5">
    <h2 class="text-lg font-bold mb-3">1) (per ora ignoriamo il poligono) </h2>
    <div id="map" class="rounded-xl overflow-hidden"></div>
  </section>

  <aside class="glass rounded-2xl p-5">
    <h2 class="text-lg font-bold mb-3">2) Dettagli & link/QR</h2>

    <label for="roomName" class="text-sm block mb-1 opacity-80">Nome della chat <span class="opacity-70">(obbligatorio)</span></label>
    <input id="roomName" class="w-full chip rounded-lg p-3 mb-3" placeholder="Es. IMIN · Bar Centrale" maxlength="80" />

    <label class="text-sm block mb-1 opacity-80">Descrizione (opzionale)</label>
    <textarea id="desc" class="w-full chip rounded-lg p-3 h-28 mb-3" placeholder="Es. Chat del Bar Centrale…"></textarea>

    <button id="createBtn" class="btn-main w-full rounded-lg py-2.5">Crea chat (test minimo)</button>

    <div id="qrWrap" class="hidden mt-5 text-center">
      <h3 class="font-bold mb-2">QR della stanza</h3>
      <img id="qrImg" class="inline-block rounded-lg" alt="QR" />
      <div class="mt-2 text-xs break-all opacity-80" id="roomLink"></div>
    </div>
  </aside>
</main>

<script>
  // ---- CONFIG
  const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // login check
  (async ()=>{
    const { data: { session } } = await sb.auth.getSession();
    const link = document.getElementById('authLink');
    if (session){
      link.textContent = 'Esci';
      link.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.href='index.html'; }
    } else {
      link.textContent = 'Entra';
      link.href = 'auth.html';
      location.href = 'auth.html?next=create.html';
      return;
    }
  })();

  // Mappa “finta” per ora
  window.initMap = function(){
    new google.maps.Map(document.getElementById('map'),{
      center:{lat:41.9028,lng:12.4964}, zoom:12, streetViewControl:false, mapTypeControl:true
    });
  }

  // Crea stanza (SOLO nome + owner_id)
  document.getElementById('createBtn').onclick = async ()=>{
    const name = document.getElementById('roomName').value.trim();
    if (!name){ alert('Inserisci il nome della chat.'); return; }

    const { data: userRes } = await sb.auth.getUser();
    const ownerId = userRes?.user?.id || null;

    const payload = {
      name,
      description: document.getElementById('desc').value.trim() || null,
      owner_id: ownerId,
      is_active: true,
      featured: false
    };

    const { data, error } = await sb.from('rooms').insert(payload).select('id').single();
    if (error){
      console.error('INSERT ERROR (min):', error, payload);
      alert('ERRORE SUPABASE (min):\n' + JSON.stringify(error, null, 2));
      return;
    }

    const link = `${location.origin.replace(/\/$/,'')}/join.html?room=${encodeURIComponent(data.id)}`;
    document.getElementById('roomLink').textContent = link;
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(link)}`;
    const img = document.getElementById('qrImg'); img.src = qr; img.alt = 'QR stanza';
    document.getElementById('qrWrap').classList.remove('hidden');

    alert('OK! Stanza creata.');
  };
</script>
</body>
</html>
