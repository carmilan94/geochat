<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat • Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:,">
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">GeoChat • Admin</h1>
      <div id="authBox" class="flex items-center gap-2"></div>
    </header>

    <div id="notAdmin" class="hidden p-4 bg-rose-100 text-rose-800 rounded-lg">
      Non sei autorizzato. Accedi con un account <b>admin</b>.
    </div>

    <section id="adminPanel" class="hidden">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Stanze</h2>
        <div class="flex items-center gap-2">
          <input id="searchInput" class="px-3 py-2 border rounded-lg" placeholder="Cerca per nome o indirizzo…" />
          <button id="refreshBtn" class="px-3 py-2 rounded-lg border">Aggiorna</button>
        </div>
      </div>
      <div id="roomsWrap" class="bg-white rounded-xl shadow divide-y"></div>
    </section>

    <pre id="errBox" class="hidden mt-6 p-3 bg-yellow-50 text-yellow-800 rounded-lg text-xs whitespace-pre-wrap"></pre>
  </div>

  <!-- UMD build (no module import) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Mostra eventuali errori a schermo
    function showErr(e){
      const box = document.getElementById('errBox');
      box.textContent = String(e && e.message ? e.message : e);
      box.classList.remove('hidden');
      console.error(e);
    }

    // === CONFIG SUPABASE ===
    const SUPABASE_URL = "https://lkdtvaiwlnkxwvlimvqs.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8";

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    } catch (e) { showErr(e); }

    const authBox    = document.getElementById('authBox');
    const adminPanel = document.getElementById('adminPanel');
    const notAdmin   = document.getElementById('notAdmin');
    const roomsWrap  = document.getElementById('roomsWrap');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput= document.getElementById('searchInput');

    async function renderAuth(){
      try{
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) throw error;
        authBox.innerHTML = "";
        if (!user) {
          const input = document.createElement('input');
          input.placeholder = 'Email';
          input.className = 'px-3 py-2 border rounded-lg';
          const btn = document.createElement('button');
          btn.textContent = 'Invia magic link';
          btn.className = 'px-3 py-2 rounded-lg bg-slate-900 text-white';
          btn.onclick = async () => {
            try{
              const email = input.value.trim();
              if (!email) return;
              const { error: e } = await supabase.auth.signInWithOtp({ email });
              if (e) throw e;
              alert('Controlla la tua email ✔️');
            } catch(e){ showErr(e); }
          };
          authBox.append(input, btn);
          notAdmin.classList.remove('hidden');
          adminPanel.classList.add('hidden');
        } else {
          const span = document.createElement('span');
          span.textContent = user.email;
          const out = document.createElement('button');
          out.textContent = 'Esci';
          out.className = 'px-3 py-2 rounded-lg border';
          out.onclick = async ()=> { await supabase.auth.signOut(); location.reload(); };
          authBox.append(span, out);

          const { data: prof, error: e2 } = await supabase
            .from('profiles').select('role').eq('id', user.id).single();
          if (e2) throw e2;

          if (prof?.role === 'admin') {
            notAdmin.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            loadRooms();
          } else {
            notAdmin.classList.remove('hidden');
            adminPanel.classList.add('hidden');
          }
        }
      } catch(e){ showErr(e); }
    }

    async function loadRooms(){
      roomsWrap.innerHTML = '<div class="p-4 text-slate-500">Carico…</div>';
      try{
        let query = supabase
          .from('rooms')
          .select('id,name,address,created_at')
          .order('created_at', { ascending: false })
          .limit(200);

        const term = (searchInput.value||'').trim().toLowerCase();
        let rooms;
        if (term) {
          const { data } = await query;
          rooms = (data||[]).filter(x =>
            (x.name||'').toLowerCase().includes(term) ||
            (x.address||'').toLowerCase().includes(term)
          );
        } else {
          const { data, error } = await query;
          if (error) throw error;
          rooms = data||[];
        }

        const cutoff = new Date(Date.now() - 2*60*1000).toISOString();
        const { data: pres } = await supabase
          .from('room_presence')
          .select('room_id,last_seen')
          .gt('last_seen', cutoff);

        const countMap = {};
        (pres||[]).forEach(r => { countMap[r.room_id] = (countMap[r.room_id]||0) + 1; });

        roomsWrap.innerHTML = '';
        if (!rooms.length) {
          roomsWrap.innerHTML = '<div class="p-4 text-slate-500">Nessuna stanza trovata.</div>';
          return;
        }

        rooms.forEach(r => {
          const row = document.createElement('div');
          row.className = 'p-4 flex items-center justify-between';

          const left = document.createElement('div');
          left.innerHTML = `
            <div class="font-medium">${escapeHtml(r.name || '—')}</div>
            <div class="text-sm text-slate-600">${escapeHtml(r.address || '—')}</div>
            <div class="text-xs text-slate-500">${new Date(r.created_at).toLocaleString()}</div>
            <div class="mt-2">
              <a class="text-xs text-slate-700 underline" href="${location.origin + location.pathname.replace('admin.html','')}?room=${r.id}" target="_blank">Apri come utente</a>
            </div>
          `;

          const right = document.createElement('div');
          right.className = 'flex items-center gap-2';

          const badge = document.createElement('span');
          badge.className = 'text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700';
          badge.textContent = (countMap[r.id]||0) + ' online';

          const del = document.createElement('button');
          del.textContent = 'Elimina';
          del.className = 'px-3 py-2 rounded-lg bg-rose-600 text-white';
          del.onclick = async () => {
            if (!confirm('Eliminare la stanza?')) return;
            try{
              const { error: e } = await supabase.from('rooms').delete().eq('id', r.id);
              if (e) throw e;
              loadRooms();
            } catch(e){ showErr(e); }
          };

          right.append(badge, del);
          row.append(left, right);
          roomsWrap.append(row);
        });
      } catch(e){ showErr(e); }
    }

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    refreshBtn && (refreshBtn.onclick = loadRooms);
    searchInput && searchInput.addEventListener('input', () => { loadRooms(); });

    // Render all
    renderAuth();
  </script>
</body>
</html>
