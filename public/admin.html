<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMIN â€¢ Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:,">
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:800}
    .grid-cards{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:700px){ .grid-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1024px){ .grid-cards{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .qr-wrap{display:flex;gap:10px;align-items:center;justify-content:center}
    .qr-box{background:#fff;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center}
    .qr-box canvas,.qr-box img{width:160px;height:160px;display:block}
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- QR code (client-side). La build UMD espone "QRCode" in window -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">IM</div>
    <div class="font-extrabold text-xl">IMIN â€¢ Admin</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="index.html" class="chip px-3 py-1.5 rounded-lg">Home</a>
    <a href="create.html" class="chip px-3 py-1.5 rounded-lg">Crea chat</a>
    <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
  </nav>
</header>

<main class="max-w-7xl mx-auto px-4 pb-20">
  <div id="msg" class="glass rounded-xl p-3 mb-4 text-sm hidden"></div>

  <section class="glass rounded-2xl p-4 mb-4">
    <h2 class="text-lg font-bold mb-2">Stanze (tutte)</h2>
    <div class="text-sm opacity-80 mb-2">Qui vedi tutte le chat create. Per ogni stanza puoi scaricare il QR del link di ingresso.</div>
    <div id="roomsGrid" class="grid-cards"></div>

    <div class="mt-4 flex items-center justify-between">
      <div id="countText" class="text-sm opacity-80"></div>
      <div class="flex gap-2">
        <button id="btnReload" class="chip rounded-lg px-3 py-1.5 text-sm">ðŸ”„ Ricarica</button>
        <button id="btnMore" class="chip rounded-lg px-3 py-1.5 text-sm hidden">Mostra altri</button>
      </div>
    </div>
  </section>
</main>

<script>
  // ========= CONFIG =========
  const SUPABASE_URL  = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // dominio principale per i link nel QR
  const BASE_APP_URL = 'https://geochat-pi.vercel.app'; // cambia se usi altro dominio

  // ========= STATE =========
  let loadedCount = 0;

  const els = {
    msg: document.getElementById('msg'),
    roomsGrid: document.getElementById('roomsGrid'),
    countText: document.getElementById('countText'),
    btnReload: document.getElementById('btnReload'),
    btnMore: document.getElementById('btnMore'),
    authLink: document.getElementById('authLink'),
  };

  // ========= INIT =========
  (async function init(){
    const { data:{ session } } = await sb.auth.getSession();
    if (session) {
      els.authLink.textContent = 'Esci';
      els.authLink.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.href='index.html'; };
    } else {
      els.authLink.textContent = 'Entra';
      els.authLink.href = 'auth.html';
    }

    els.btnReload.onclick = reload;
    els.btnMore.onclick = loadMore;

    await reload();
  })();

  async function reload(){
    els.roomsGrid.innerHTML = '';
    loadedCount = 0;
    await loadMore();
  }

  async function loadMore(){
    showMsg('');
    const PAGE_SIZE = 24;

    const { data, error, count } = await sb
      .from('rooms')
      .select('id, name, address, created_at', { count: 'exact' })
      .order('created_at', { ascending: false })
      .range(loadedCount, loadedCount + PAGE_SIZE - 1);

    if (error) { showMsg('Errore nel caricamento: ' + error.message, true); return; }

    if (!data || data.length === 0){
      if (loadedCount === 0) els.roomsGrid.innerHTML = '<div class="opacity-80 text-sm p-3">Nessuna stanza trovata.</div>';
      els.btnMore.classList.add('hidden');
      els.countText.textContent = `Totale: ${count || 0}`;
      return;
    }

    data.forEach(room => renderRoomCard(room));
    loadedCount += data.length;
    els.countText.textContent = `Mostrate: ${loadedCount}${count!=null ? ' / ' + count : ''}`;

    if (count != null && loadedCount < count) els.btnMore.classList.remove('hidden');
    else els.btnMore.classList.add('hidden');
  }

  function renderRoomCard(room){
    const linkJoin = `${BASE_APP_URL}/join.html?room=${encodeURIComponent(room.id)}`;
    const linkChat = `${BASE_APP_URL}/chat.html?room=${encodeURIComponent(room.id)}`;

    const card = document.createElement('div');
    card.className = 'glass rounded-2xl p-4 flex flex-col gap-3';

    // header
    const h = document.createElement('div');
    h.innerHTML = `
      <div class="font-bold text-lg">${escapeHtml(room.name || 'Chat')}</div>
      <div class="text-xs opacity-80">${escapeHtml(room.address || 'â€”')}</div>
      <div class="text-xs opacity-60">ID: <code>${room.id}</code></div>
      <div class="text-xs opacity-60">Creato: ${formatDate(room.created_at)}</div>
    `;
    card.appendChild(h);

    // QR + actions
    const qrWrap = document.createElement('div');
    qrWrap.className = 'qr-wrap';
    const qrBox = document.createElement('div');
    qrBox.className = 'qr-box rounded-xl';
    qrWrap.appendChild(qrBox);
    card.appendChild(qrWrap);

    // Canvas principale + fallback IMG
    const canvas = document.createElement('canvas');
    canvas.width = 160; canvas.height = 160;
    qrBox.appendChild(canvas);

    // genera il QR (client-side) â€“ con colori espliciti
    generateCanvasQR(canvas, linkJoin).catch(()=>{
      // Fallback: immagine da servizio esterno
      const img = document.createElement('img');
      img.alt = 'QR';
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(linkJoin)}`;
      qrBox.innerHTML = '';
      qrBox.appendChild(img);
      canvas.__fallbackImg = img; // referenza per download
    });

    // Azioni
    const actions = document.createElement('div');
    actions.className = 'flex flex-wrap gap-2 justify-between items-center';

    const leftGroup = document.createElement('div');
    leftGroup.className = 'flex gap-2';
    const btnCopy = document.createElement('button');
    btnCopy.className = 'chip rounded-lg px-3 py-1.5 text-sm';
    btnCopy.textContent = 'Copia link';
    btnCopy.onclick = async ()=>{
      try { await navigator.clipboard.writeText(linkJoin); toast('Link copiato!'); }
      catch{ toast('Impossibile copiare'); }
    };

    const btnDownload = document.createElement('button');
    btnDownload.className = 'chip rounded-lg px-3 py-1.5 text-sm';
    btnDownload.textContent = 'Scarica QR (PNG)';
    btnDownload.onclick = ()=> downloadQR(qrBox, `qr_${room.id}.png`);

    leftGroup.appendChild(btnCopy);
    leftGroup.appendChild(btnDownload);

    const rightGroup = document.createElement('div');
    rightGroup.className = 'flex gap-2';
    const aJoin = document.createElement('a');
    aJoin.className = 'chip rounded-lg px-3 py-1.5 text-sm';
    aJoin.href = linkJoin; aJoin.target = '_blank'; aJoin.textContent = 'Apri Join';

    const aChat = document.createElement('a');
    aChat.className = 'btn-main rounded-lg px-3 py-1.5 text-sm';
    aChat.href = linkChat; aChat.target = '_blank'; aChat.textContent = 'Apri Chat';

    rightGroup.appendChild(aJoin);
    rightGroup.appendChild(aChat);

    actions.appendChild(leftGroup);
    actions.appendChild(rightGroup);
    card.appendChild(actions);

    els.roomsGrid.appendChild(card);
  }

  // ======== QR helpers ========
  async function generateCanvasQR(canvas, text){
    // Usa promise (alcuni browser non chiamano correttamente il callback)
    await QRCode.toCanvas(
      canvas,
      text,
      {
        width: 160,
        margin: 1,
        color: {
          dark: '#000000',   // moduli neri
          light: '#ffffff'   // sfondo bianco
        }
      }
    );
  }

  function downloadQR(qrBox, filename){
    // se c'Ã¨ un canvas, scarica quello; altrimenti l'immagine di fallback
    const canvas = qrBox.querySelector('canvas');
    const img = qrBox.querySelector('img');

    let url;
    if (canvas && canvas.toDataURL) {
      url = canvas.toDataURL('image/png');
    } else if (img && img.src) {
      url = img.src; // scarica l'immagine dal servizio
    } else {
      toast('QR non disponibile.');
      return;
    }
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'qr.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ========= UTILS =========
  function showMsg(t, isErr){
    els.msg.classList.toggle('hidden', !t);
    els.msg.textContent = t || '';
    els.msg.style.color = isErr ? '#fecaca' : '#e5e7eb';
  }
  function toast(t){ showMsg(t,false); clearTimeout(window.__t); window.__t=setTimeout(()=>showMsg('',false),1200); }
  function formatDate(iso){ try { return new Date(iso).toLocaleString(); } catch { return iso||'â€”'; } }
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
</script>
</body>
</html>
