<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IMIN • Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:800}
    a.user{color:#ffd18a;text-decoration:underline}

    /* lista messaggi */
    #messages{height:60vh;overflow-y:auto;scroll-behavior:smooth;padding:6px}

    /* bubbles slim stile WhatsApp */
    .row{padding:.22rem .18rem}
    .meta{font-size:.68rem;opacity:.65;margin:0 .25rem .22rem}
    .bubble{
      display:inline-block;
      padding:.45rem .65rem;
      border-radius:14px;
      font-size:14px;
      line-height:1.32;
      max-width:72%;
      word-wrap:break-word;
      box-shadow:0 1px 2px rgba(0,0,0,.25)
    }
    .bubble-other{background:#1b1b1d;border:1px solid rgba(255,255,255,.08);color:#f3f3f3}
    .bubble-me{background:#ffb84d;color:#111} /* arancione pastello */
    @media (max-width:480px){ .bubble{max-width:78%} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="w-full py-3 px-4">
  <div class="max-w-4xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
      <div id="roomTitle" class="font-extrabold text-xl">GeoChat</div>
    </div>
    <nav class="flex items-center gap-3 text-sm">
      <a href="index.html" class="chip px-3 py-1.5 rounded-lg">Home</a>
      <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
    </nav>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-24">
  <div id="roomHeader" class="glass rounded-xl px-4 py-3 mb-3 cursor-pointer flex items-center justify-between">
    <div>
      <div id="roomName" class="font-extrabold text-lg underline decoration-white/30">Chat</div>
      <div id="activeCount" class="text-xs opacity-80">Membri attivi — …</div>
    </div>
    <div class="chip rounded-lg px-3 py-1.5 text-xs">Vedi membri</div>
  </div>

  <div id="messages" class="glass rounded-xl"></div>

  <div class="mt-3 flex gap-2">
    <input id="msgInput" class="flex-1 chip rounded-lg px-3 py-2" placeholder="Scrivi un messaggio… (Invio per inviare)"/>
    <button id="sendBtn" class="btn-main rounded-lg px-4">Invia</button>
  </div>
</main>

<!-- Modale presenza -->
<div id="presenceModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-[#151515] border border-[#252525] rounded-xl p-4 w-[92%] max-w-md">
    <div class="flex items-center justify-between mb-2">
      <div class="font-bold">Membri attivi</div>
      <button id="closePresence" class="chip rounded-md px-2 py-1 text-sm">Chiudi</button>
    </div>
    <div id="presenceList" class="divide-y divide-white/10"></div>
  </div>
</div>

<script>
const SUPABASE_URL  = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const qs = new URLSearchParams(location.search);
const roomId = qs.get('room');

const messagesEl    = document.getElementById('messages');
const msgInput      = document.getElementById('msgInput');
const sendBtn       = document.getElementById('sendBtn');
const roomTitleEl   = document.getElementById('roomTitle');
const roomNameEl    = document.getElementById('roomName');
const activeCount   = document.getElementById('activeCount');
const presenceModal = document.getElementById('presenceModal');
const presenceList  = document.getElementById('presenceList');

let me = null;                      // session.user
let profileCache = new Map();       // user_id -> display_name
let presenceChannel = null;

// ------------ INIT ------------
(async function init(){
  if (!roomId){ alert('Stanza non trovata'); location.href='index.html'; return; }

  const { data:{ session } } = await sb.auth.getSession();
  if (!session){ location.href='auth.html?next='+encodeURIComponent(location.pathname+location.search); return; }
  me = session.user;

  const link = document.getElementById('authLink');
  link.textContent = 'Esci';
  link.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.href='index.html'; };

  const { data: room } = await sb.from('rooms').select('name').eq('id', roomId).maybeSingle();
  roomTitleEl.textContent = room?.name || 'GeoChat';
  roomNameEl.textContent  = room?.name || 'Chat locale';

  await loadMessages();
  subscribeRealtime();
  setupPresence();

  sendBtn.onclick = sendMessage;
  msgInput.addEventListener('keydown', e=>{
    if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  document.getElementById('roomHeader').onclick = () => presenceModal.classList.remove('hidden');
  document.getElementById('closePresence').onclick = () => presenceModal.classList.add('hidden');
})();

// ------------ LOAD ------------
async function loadMessages(){
  const { data, error } = await sb.from('messages')
    .select('id, body, created_at, user_id')
    .eq('room_id', roomId)
    .order('created_at', { ascending: true })
    .limit(200);

  messagesEl.innerHTML='';
  if (error){
    messagesEl.innerHTML = '<div class="p-3 text-sm text-red-300">Errore nel caricamento.</div>';
    return;
  }
  for (const m of (data||[])) await renderMessage(m);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// ------------ REALTIME ------------
function subscribeRealtime(){
  sb.channel('public:messages:'+roomId)
    .on('postgres_changes',
      { event:'INSERT', schema:'public', table:'messages', filter:'room_id=eq.'+roomId },
      async payload => { await renderMessage(payload.new); messagesEl.scrollTop = messagesEl.scrollHeight; }
    ).subscribe();
}

// ------------ DISPLAY NAME via user_id (cache) ------------
async function getDisplayName(uid){
  if (!uid) return 'Anonimo';
  if (uid === me.id) return 'Tu';  // i miei messaggi
  const cached = profileCache.get(uid);
  if (cached) return cached;
  const { data } = await sb.from('profiles').select('display_name').eq('id', uid).maybeSingle();
  const dn = data?.display_name || 'Anonimo';
  profileCache.set(uid, dn);
  return dn;
}

// ------------ RENDER MESSAGE ------------
async function renderMessage(m){
  const uid  = m.user_id || null;
  const mine = uid === me.id;
  const who  = await getDisplayName(uid);
  const time = m.created_at ? new Date(m.created_at).toLocaleTimeString() : '';

  // wrapper riga che controlla l'allineamento di TUTTO (meta + bubble)
  const row = document.createElement('div');
  row.className = 'row flex ' + (mine ? 'justify-end' : 'justify-start');

  // blocco verticale (meta sopra, bubble sotto)
  const block = document.createElement('div');
  block.className = 'flex flex-col ' + (mine ? 'items-end' : 'items-start');

  const meta = document.createElement('div');
  meta.className = 'meta ' + (mine ? 'text-right' : 'text-left');
  meta.innerHTML = mine
    ? `<span class="font-medium text-amber-400">Tu</span> <span>${time}</span>`
    : `<a class="user font-medium" href="profile.html?uid=${encodeURIComponent(uid||'')}">${escapeHtml(who)}</a> <span>${time}</span>`;

  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (mine ? 'bubble-me' : 'bubble-other');
  bubble.innerHTML = linkify(escapeHtml(m.body||''));

  block.appendChild(meta);
  block.appendChild(bubble);
  row.appendChild(block);
  messagesEl.appendChild(row);
}

// ------------ SEND ------------
async function sendMessage(){
  const txt = (msgInput.value||'').trim();
  if (!txt) return;
  msgInput.value='';
  const { error } = await sb.from('messages').insert({ room_id: roomId, user_id: me.id, body: txt });
  if (error){ console.error(error); alert('Errore invio messaggio: '+error.message); }
}

// ------------ PRESENCE ------------
function setupPresence(){
  const ch = sb.channel('presence:room:'+roomId, { config: { presence: { key: me.id } } });

  const refresh = ()=>{
    const state = ch.presenceState(); // { uid: [ {display_name}, ... ] }
    const ids = Object.keys(state||{});
    activeCount.textContent = `${ids.length} membri attivi`;
    presenceList.innerHTML = ids.length
      ? ids.map(uid=>{
          const dn = (state[uid]?.[0]?.display_name) || 'Anonimo';
          return `<div class="py-2 text-sm"><a class="user" href="profile.html?uid=${encodeURIComponent(uid)}">${escapeHtml(dn)}</a></div>`;
        }).join('')
      : '<div class="py-4 text-sm opacity-70">Nessuno online al momento.</div>';
  };

  ch.on('presence', { event:'sync' }, refresh);
  ch.on('presence', { event:'join' }, refresh);
  ch.on('presence', { event:'leave' }, refresh);

  ch.subscribe(async status=>{
    if (status==='SUBSCRIBED'){
      const { data } = await sb.from('profiles').select('display_name').eq('id', me.id).maybeSingle();
      await ch.track({ display_name: data?.display_name || 'Anonimo', room_id: roomId });
    }
  });

  // store per cleanup
  presenceChannel = ch;
}

// ------------ UTILS ------------
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function linkify(t){return t.replace(/\b(https?:\/\/[^\s<]+)\b/g,'<a class="user" href="$1" target="_blank" rel="noopener">$1</a>');}

window.addEventListener('beforeunload',()=>{ try{ presenceChannel?.untrack(); }catch(_){} });
</script>
</body>
</html>
