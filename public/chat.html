<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IMIN • Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:800}
    a.user{color:#ffd18a;text-decoration:underline}
    .msg{border-bottom:1px solid rgba(255,255,255,.06)}
    .msg-time{opacity:.6;font-size:.72rem}
    .scroll{scroll-behavior:smooth}
  </style>
</head>
<body>
<header class="w-full py-3 px-4">
  <div class="max-w-4xl mx-auto">
    <nav class="flex items-center justify-between">
      <a href="index.html" class="chip px-3 py-1.5 rounded-lg text-sm">⟵ Home</a>
      <a href="create.html" class="chip px-3 py-1.5 rounded-lg text-sm">Crea chat</a>
    </nav>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-24">
  <!-- HEADER CHAT -->
  <div id="roomHeader" class="glass rounded-xl px-4 py-3 mb-3 cursor-pointer">
    <div class="flex items-center justify-between gap-3">
      <div>
        <div id="roomName" class="font-extrabold text-lg underline decoration-white/30">Chat</div>
        <div id="activeCount" class="text-xs opacity-80">Membri attivi — …</div>
      </div>
      <div class="chip rounded-lg px-3 py-1.5 text-xs">Vedi membri</div>
    </div>
  </div>

  <!-- LISTA MESSAGGI -->
  <div id="messages" class="glass rounded-xl p-3 h-[60vh] overflow-y-auto scroll"></div>

  <!-- INPUT -->
  <div class="mt-3 flex gap-2">
    <input id="msgInput" class="flex-1 chip rounded-lg px-3 py-2" placeholder="Scrivi un messaggio… (Invio per inviare)"/>
    <button id="sendBtn" class="btn-main rounded-lg px-4">Invia</button>
  </div>
</main>

<!-- MODALE PRESENZA -->
<div id="presenceModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-[#151515] border border-[#252525] rounded-xl p-4 w-[92%] max-w-md">
    <div class="flex items-center justify-between mb-2">
      <div class="font-bold">Membri attivi</div>
      <button id="closePresence" class="chip rounded-md px-2 py-1 text-sm">Chiudi</button>
    </div>
    <div id="presenceList" class="divide-y divide-white/10"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL  = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const qs = new URLSearchParams(location.search);
const roomId = qs.get('room');

const messagesEl   = document.getElementById('messages');
const msgInput     = document.getElementById('msgInput');
const sendBtn      = document.getElementById('sendBtn');
const roomNameEl   = document.getElementById('roomName');
const activeCount  = document.getElementById('activeCount');
const presenceModal= document.getElementById('presenceModal');
const presenceList = document.getElementById('presenceList');
const roomHeader   = document.getElementById('roomHeader');

let sessionUser = null;
let meName = 'Utente';
let profileCache = new Map(); // user_id -> {display_name}
let presenceState = {};       // user_id -> {display_name}
let presenceChannel = null;

// ---------- INIT ----------
(async function init(){
  if (!roomId){ alert('Stanza non trovata'); location.href='index.html'; return; }

  const { data: { session } } = await sb.auth.getSession();
  if (!session){ location.href = 'auth.html?next=' + encodeURIComponent(location.pathname + location.search); return; }
  sessionUser = session.user;

  // prendo display_name utente loggato
  const { data: meProf } = await sb.from('profiles').select('display_name').eq('id', sessionUser.id).maybeSingle();
  meName = meProf?.display_name || (sessionUser.email||'').split('@')[0] || 'Utente';

  // nome stanza
  const { data: room } = await sb.from('rooms').select('name').eq('id', roomId).maybeSingle();
  roomNameEl.textContent = room?.name || 'Chat locale';

  // carica messaggi iniziali
  await loadMessages();

  // subscribe nuovi messaggi
  sb.channel('public:messages:'+roomId)
    .on('postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'messages', filter: 'room_id=eq.'+roomId },
      payload => renderMessage(payload.new)
    )
    .subscribe();

  // presence realtime
  presenceChannel = sb.channel('presence:room:'+roomId, { config: { presence: { key: sessionUser.id } } });

  presenceChannel.on('presence', { event: 'sync' }, () => {
    const raw = presenceChannel.presenceState(); // { user_id: [ {display_name}, ... ] }
    const next = {};
    Object.entries(raw).forEach(([uid, metas])=>{
      if (metas && metas.length) next[uid] = { display_name: metas[0].display_name || 'Utente' };
    });
    presenceState = next;
    updatePresenceUI();
  });

  presenceChannel.on('presence', { event: 'join' }, () => updatePresenceUI());
  presenceChannel.on('presence', { event: 'leave' }, () => updatePresenceUI());

  await presenceChannel.subscribe(async (status) => {
    if (status === 'SUBSCRIBED') {
      await presenceChannel.track({ display_name: meName, room_id: roomId });
    }
  });

  // UI handlers
  sendBtn.onclick = sendMessage;
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  roomHeader.onclick = () => presenceModal.classList.remove('hidden');
  document.getElementById('closePresence').onclick = () => presenceModal.classList.add('hidden');
})();

// ---------- LOAD / RENDER ----------
async function loadMessages(){
  messagesEl.innerHTML = '<div class="text-sm opacity-70 p-2">Caricamento…</div>';
  const { data, error } = await sb
    .from('messages')
    .select('id, content, created_at, user_id')
    .eq('room_id', roomId)
    .order('created_at', { ascending: true })
    .limit(200);
  if (error){ messagesEl.innerHTML = '<div class="text-sm text-red-300 p-2">Errore nel caricamento.</div>'; return; }
  messagesEl.innerHTML = '';
  for (const m of data) renderMessage(m);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function renderMessage(msg){
  // prendi display_name da cache o dal DB
  let name = profileCache.get(msg.user_id)?.display_name;
  if (!name && msg.user_id){
    const { data: prof } = await sb.from('profiles').select('display_name').eq('id', msg.user_id).maybeSingle();
    name = prof?.display_name || 'Utente';
    profileCache.set(msg.user_id, { display_name: name });
  }
  const who = name || 'Utente';
  const uid = msg.user_id;

  const time = msg.created_at ? new Date(msg.created_at).toLocaleTimeString() : '';
  const mine = uid === sessionUser.id;

  const wrap = document.createElement('div');
  wrap.className = 'msg py-2';
  wrap.innerHTML = `
    <div class="flex items-start gap-2 ${mine ? 'flex-row-reverse text-right' : ''}">
      <div class="flex-1">
        <div class="text-xs mb-0.5">
          <a class="user" href="profile.html?uid=${encodeURIComponent(uid || '')}" target="_self">${escapeHtml(who)}</a>
          <span class="msg-time ${mine ? 'mr-1' : 'ml-1'}">${time}</span>
        </div>
        <div class="inline-block max-w-[90%] ${mine ? 'bg-amber-400 text-black' : 'chip'} rounded-lg px-3 py-2 whitespace-pre-wrap break-words">
          ${linkify(escapeHtml(msg.content || ''))}
        </div>
      </div>
    </div>
  `;
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// ---------- SEND ----------
async function sendMessage(){
  const text = (msgInput.value || '').trim();
  if (!text) return;
  msgInput.value = '';
  const { error } = await sb.from('messages').insert({
    room_id: roomId,
    user_id: sessionUser.id,
    content: text
  });
  if (error){
    console.error(error);
    alert('Errore invio messaggio: ' + error.message);
  }
}

// ---------- PRESENCE UI ----------
function updatePresenceUI(){
  const ids = Object.keys(presenceState);
  activeCount.textContent = `${ids.length} membri attivi`;
  presenceList.innerHTML = ids.length
    ? ids.map(uid => {
        const dn = presenceState[uid]?.display_name || 'Utente';
        return `<div class="py-2 text-sm">
          <a class="user" href="profile.html?uid=${encodeURIComponent(uid)}">${escapeHtml(dn)}</a>
        </div>`;
      }).join('')
    : '<div class="py-4 text-sm opacity-70">Nessuno online al momento.</div>';
}

// ---------- UTILS ----------
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function linkify(text){
  const urlRe = /\b(https?:\/\/[^\s<]+)\b/g;
  return text.replace(urlRe, '<a class="user" href="$1" target="_blank" rel="noopener">$1</a>');
}

// ---------- CLEANUP on unload ----------
window.addEventListener('beforeunload', () => {
  if (presenceChannel) presenceChannel.untrack().catch(()=>{});
});
</script>
</body>
</html>
