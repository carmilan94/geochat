<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GeoChat • Il mio profilo</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0b0c;--card:#141417;--fg:#f6f6f7;--muted:#8a8a94;--brand:#ff8a00;--border:#232328;--danger:#ff6767}
    *{box-sizing:border-box} body{margin:0;background:#0b0b0c;color:var(--fg);font-family:system-ui,Segoe UI,Inter,Roboto,Arial}
    header{position:sticky;top:0;background:#0b0b0cdd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;justify-content:space-between}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#16161a;color:var(--fg);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#ff8a00,#ffb347);color:#1a1a1a;font-weight:700;border:none}
    .btn.danger{background:#1c1113;border-color:#472126;color:#ff9c9c}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:16px}
    h1{margin:12px 0 8px} .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:320px 1fr}}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field input,.field textarea{background:#0f0f12;border:1px solid var(--border);color:var(--fg);border-radius:12px;padding:12px}
    .hint{font-size:12px;color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#101014;border:1px solid var(--border)}
    .avatar{width:140px;height:140px;border-radius:999px;object-fit:cover;border:2px solid var(--border);background:#0f0f12}
    .toast{position:fixed;right:18px;bottom:18px;background:#141417;border:1px solid var(--border);padding:12px 14px;border-radius:12px;display:none}
    .error{border:1px solid #402225;background:#1a1011;color:#f9b9b9;padding:12px;border-radius:12px;margin-top:10px;display:none;white-space:pre-wrap}
    code{background:#0e0e11;padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
    /* Gallery */
    .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media(max-width:640px){.gallery{grid-template-columns:repeat(2,1fr)}}
    .tile{position:relative;overflow:hidden;border-radius:12px;border:1px solid var(--border);background:#0f0f12}
    .tile img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
    .tile .del{position:absolute;top:6px;right:6px;font-size:12px;border-radius:10px;padding:6px 8px}
    .caption{font-size:12px;color:var(--muted);padding:6px 2px}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="row">
        <strong>GeoChat</strong>
        <span id="meEmail" class="badge">…</span>
        <span id="uidBadge" class="badge">uid: …</span>
      </div>
      <div class="row">
        <a class="btn" href="index.html">Home</a>
        <a class="btn" href="join.html">Entra</a>
        <a class="btn" href="chat.html">Chat</a>
        <a class="btn" href="settings.html">Impostazioni</a>
        <a class="btn" href="profile.html">Profilo</a>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1>Il mio profilo</h1>
    <p class="muted">Aggiorna i tuoi dati, avatar e carica foto per la tua bacheca.</p>

    <div id="errBox" class="error"></div>

    <div class="grid">
      <!-- Avatar -->
      <section class="card">
        <h3 style="margin-top:0">Foto profilo</h3>
        <div class="row" style="gap:16px;margin:12px 0">
          <img id="avatarImg" class="avatar" alt="avatar"/>
          <div style="display:flex;flex-direction:column;gap:10px">
            <input type="file" id="avatarFile" accept="image/*"/>
            <div class="row">
              <button class="btn" id="uploadAvatarBtn" type="button">Carica avatar</button>
              <button class="btn danger" id="removeAvatarBtn" type="button">Rimuovi</button>
            </div>
            <span class="hint">Consigliato: quadrata 512×512. Salvata su <code>avatars</code> (public read).</span>
            <a id="publicLink" class="btn" target="_blank" href="#">Vedi profilo pubblico</a>
          </div>
        </div>
      </section>

      <!-- Dati profilo -->
      <section class="card">
        <h3 style="margin-top:0">Dati utente</h3>
        <form id="profileForm">
          <div class="field">
            <label for="display_name">Nome visualizzato</label>
            <input id="display_name" placeholder="Es. Carmine"/>
          </div>
          <div class="field">
            <label for="location">Di dove sei</label>
            <input id="location" placeholder="Es. Napoli (IT)"/>
          </div>
          <div class="field">
            <label for="age">Età</label>
            <input id="age" type="number" min="0" max="120" placeholder="Es. 30"/>
          </div>
          <div class="field">
            <label for="bio">Bio</label>
            <textarea id="bio" rows="4" placeholder="Scrivi qualcosa su di te…"></textarea>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" type="submit">Salva modifiche</button>
            <button class="btn" type="button" id="reloadBtn">Ricarica</button>
          </div>
          <p class="hint">I dati sono in <code>public.profiles</code> (RLS: solo tu puoi modificare).</p>
        </form>
      </section>
    </div>

    <!-- BACHECA FOTO -->
    <section class="card">
      <h3 style="margin-top:0">Bacheca foto</h3>
      <div class="row" style="gap:12px;margin-bottom:8px">
        <input type="file" id="photoFiles" accept="image/*" multiple />
        <input id="photoCaption" placeholder="Caption (facoltativa)" style="flex:1;background:#0f0f12;border:1px solid var(--border)
