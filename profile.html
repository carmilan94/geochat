<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GeoChat • Profilo</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0b0c;--card:#141417;--fg:#f6f6f7;--muted:#a2a2ab;--brand:#ff8a00;--brand2:#ffb347;--border:#232328;--danger:#ff6b6b}
    *{box-sizing:border-box} body{margin:0;background:#0b0b0c;color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0b0b0cdd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:60}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;justify-content:space-between}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#16161a;color:var(--fg);cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#111;font-weight:700;border:none}
    .btn.danger{background:#1a1112;border-color:#442325;color:#ffb3b3}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:22px;margin-top:16px}
    .avatar{width:140px;height:140px;border-radius:999px;object-fit:cover;border:2px solid var(--border);background:#0f0f12;display:block;margin:0 auto}
    .muted{color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#101014;border:1px solid var(--border)}
    .error{border:1px solid #402225;background:#1b0f11;color:#ffc6c6;padding:12px;border-radius:12px;margin-top:10px;display:none;white-space:pre-wrap}
    .toast{position:fixed;right:18px;bottom:18px;background:#141417;border:1px solid var(--border);padding:12px 14px;border-radius:12px;display:none;z-index:80}

    /* header profilo */
    .profile-header{display:grid;grid-template-columns:140px 1fr;gap:18px;align-items:center}
    @media(max-width:600px){.profile-header{grid-template-columns:1fr;justify-items:center;text-align:center}}
    .h1{font-size:26px;font-weight:800;margin:0}
    .sub{margin:6px 0 0}

    /* pannello edit */
    .edit{margin-top:16px;border-top:1px dashed var(--border);padding-top:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field textarea{background:#0f0f12;border:1px solid var(--border);color:var(--fg);border-radius:12px;padding:12px}

    /* gallery */
    .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media(max-width:640px){.gallery{grid-template-columns:repeat(2,1fr)}}
    .tile{position:relative;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#0f0f12;cursor:pointer}
    .tile img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
    .tile .del{position:absolute;top:6px;right:6px;font-size:12px;border-radius:999px;padding:6px 8px}
    .tile .cap{position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);padding:4px 8px;border-radius:10px;font-size:12px}

    /* fab */
    .fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;font-size:28px;font-weight:900;border:none;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#111;cursor:pointer;box-shadow:0 6px 22px rgba(0,0,0,.4);z-index:50}

    /* modale upload */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:70}
    .modal{width:min(720px,100%);background:#151519;border:1px solid var(--border);border-radius:18px;padding:16px}
    .list{display:flex;flex-direction:column;gap:12px;max-height:50vh;overflow:auto;margin:12px 0}
    .item{display:grid;grid-template-columns:72px 1fr;gap:12px;align-items:center;background:#101015;border:1px solid var(--border);padding:8px;border-radius:12px}
    .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .item input{width:100%;background:#0e0e12;border:1px solid var(--border);border-radius:10px;padding:10px;color:#fff}
    .bar{height:6px;background:#0e0e12;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2))}

    /* === MOBILE NAV (hamburger + drawer) === */
    .nav-right{display:flex}
    .hamburger{display:none;gap:5px;flex-direction:column;align-items:center;justify-content:center;
      padding:10px;border-radius:12px;border:1px solid var(--border);background:#16161a;cursor:pointer}
    .hamburger span{width:22px;height:2px;background:var(--fg);display:block}
    @media(max-width:900px){.nav-right{display:none}.hamburger{display:flex}}
    .mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:70}
    .mobile-overlay.open{display:block}
    .mobile-drawer{position:fixed;top:0;right:0;height:100vh;width:min(320px,85vw);
      background:#141417;border-left:1px solid var(--border);
      transform:translateX(100%);transition:transform .22s ease;
      display:flex;flex-direction:column;gap:12px;padding:16px;z-index:71}
    .mobile-drawer.open{transform:translateX(0)}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .drawer-nav{display:flex;flex-direction:column;gap:8px}
    .drawer-nav .mitem{display:block;text-decoration:none;color:var(--fg);
      background:#16161a;border:1px solid var(--border);border-radius:12px;padding:12px 14px;text-align:left}
    .drawer-nav .mitem.logout{background:#1a1112;border-color:#442325;color:#ffb3b3}

    /* === VIEWER (zoom stile Instagram) — SEMPRE visibile barra commenti === */
    .viewer{position:fixed;inset:0;display:none;z-index:90;background:rgba(0,0,0,.65)}
    .viewer .box{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;padding:16px;overflow:auto}
    .viewer .panel{
      width:min(1024px,100%); height:min(90vh,100%);
      background:#141417;border:1px solid var(--border);border-radius:16px;
      display:grid;grid-template-columns:minmax(0,1fr) 380px;overflow:hidden
    }
    @media(max-width:900px){
      .viewer .panel{grid-template-columns:1fr;grid-template-rows:auto 1fr}
      .viewer .left{max-height:58vh}
      .viewer .left img{max-height:58vh}
    }
    .viewer .left{background:#0b0b0f;display:grid;place-items:center;min-width:0;min-height:0}
    .viewer .left img{max-width:100%;max-height:100%;object-fit:contain;background:#0b0b0f}
    .viewer .right{display:flex;flex-direction:column;height:100%;min-height:0}
    .viewer .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
    .viewer .meta{padding:12px;border-bottom:1px dashed var(--border)}
    .viewer .actions{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px dashed var(--border)}
    .heart{font-size:22px;line-height:1;background:#1a1a1e;border:1px solid var(--border);border-radius:12px;padding:8px 10px;cursor:pointer}
    .heart.liked{background:#2a1414;border-color:#4a2424;color:#ff9aa0}
    .viewer .comments{flex:1;min-height:0;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .comment{background:#101015;border:1px solid var(--border);border-radius:12px;padding:10px}
    .comment .by{font-size:12px;color:var(--muted)}
    .comment .text{margin:6px 0 0}
    .viewer .newc{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:#141417}
    .viewer .newc input{flex:1;background:#0f0f12;border:1px solid var(--border);color:#fff;border-radius:12px;padding:10px}

    /* === FIX viewer mobile + commenti larghi === */
    @media (max-width: 700px){
      .viewer .panel{
        width:100%;
        height:100%;
        border-radius:0;
        grid-template-columns:1fr;
        grid-template-rows:auto 1fr;
      }
      .viewer .left{ max-height:58vh; }
      .viewer .left img{ max-height:58vh; }
    }
    .viewer .comments > .comment{ width:100%; }
    .comment .by{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .btn.sm{ padding:4px 8px; font-size:12px }
    .comment .text{
      font-size:15px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="row">
        <strong>GeoChat</strong>
        <span id="meEmail" class="badge">…</span>
        <span id="uidBadge" class="badge">uid: …</span>
      </div>
      <div class="row nav-right">
        <a class="btn" href="index.html">Home</a>
        <a class="btn" href="join.html">Entra</a>
        <a class="btn" href="chat.html">Chat</a>
        <a class="btn" href="settings.html">Impostazioni</a>
        <a class="btn" href="profile.html">Profilo</a>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
      <button id="hamburger" class="hamburger" aria-label="Apri menu" aria-controls="mobileDrawer" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>
  <aside id="mobileDrawer" class="mobile-drawer" aria-hidden="true">
    <div class="drawer-head">
      <span style="font-weight:700">Menu</span>
      <button id="closeDrawer" class="btn">✕</button>
    </div>
    <nav class="drawer-nav">
      <a class="mitem" href="index.html">Home</a>
      <a class="mitem" href="join.html">Entra</a>
      <a class="mitem" href="chat.html">Chat</a>
      <a class="mitem" href="settings.html">Impostazioni</a>
      <a class="mitem" href="profile.html">Profilo</a>
      <button class="mitem logout" id="logoutBtn2" type="button">Logout</button>
    </nav>
  </aside>

  <main class="wrap">
    <section class="card">
      <div class="profile-header">
        <img id="avatarImg" class="avatar" alt="avatar"/>
        <div>
          <h1 class="h1" id="display_name_txt">—</h1>
          <p class="muted sub" id="bio_txt"></p>
          <p class="muted sub" id="extra_txt"></p>
          <div class="row" style="margin-top:10px">
            <button id="editToggle" class="btn">Modifica profilo</button>
          </div>
        </div>
      </div>

      <div id="editPanel" class="edit" style="display:none">
        <form id="profileForm" class="grid" onsubmit="return false">
          <div class="field" style="grid-column:1/-1">
            <label for="avatarFile">Foto profilo</label>
            <input type="file" id="avatarFile" accept="image/*"/>
            <p class="muted" style="margin:6px 0 0">Seleziona la foto e premi <b>Salva modifiche</b>.</p>
          </div>
          <div class="field">
            <label for="display_name">Nome visualizzato</label>
            <input id="display_name" placeholder="Es. Carmine"/>
          </div>
          <div class="field">
            <label for="location">Di dove sei</label>
            <input id="location" placeholder="Es. Napoli (IT)"/>
          </div>
          <div class="field">
            <label for="age">Età</label>
            <input id="age" type="number" min="0" max="120" placeholder="Es. 31"/>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label for="bio">Bio</label>
            <textarea id="bio" rows="3" placeholder="Scrivi qualcosa su di te…"></textarea>
          </div>
          <div class="row" style="grid-column:1/-1;justify-content:flex-end">
            <button class="btn" type="button" id="reloadBtn">Ricarica</button>
            <button class="btn primary" type="button" id="saveBtn">Salva modifiche</button>
            <button class="btn danger" type="button" id="removeAvatarBtn">Rimuovi avatar</button>
          </div>
        </form>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Bacheca</h3>
        <span class="muted" style="font-size:12px">Le foto sono pubbliche</span>
      </div>
      <div id="gallery" class="gallery" style="margin-top:12px"></div>
      <p id="empty" class="muted" style="display:none">Ancora nessuna foto.</p>
    </section>
  </main>

  <!-- FAB upload -->
  <button id="fabAdd" class="fab" title="Carica foto">+</button>

  <!-- Modale upload -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h3 style="margin:0 0 8px">Carica foto</h3>
      <p class="muted" style="margin:0">Aggiungi una didascalia per ogni immagine.</p>
      <div id="uploadList" class="list"></div>
      <div class="row" style="justify-content:flex-end">
        <button id="cancelUpload" class="btn">Annulla</button>
        <button id="startUpload" class="btn primary">Pubblica</button>
      </div>
    </div>
  </div>

  <input type="file" id="photoPicker" accept="image/*" multiple style="display:none"/>

  <!-- VIEWER Instagram-like -->
  <div id="viewer" class="viewer" aria-hidden="true">
    <div class="box">
      <div class="panel">
        <div class="left"><img id="viewImg" alt="photo"/></div>
        <div class="right">
          <div class="topbar">
            <strong id="viewOwner">Profilo</strong>
            <button id="closeViewer" class="btn">✕</button>
          </div>
          <div class="meta"><div id="viewCaption" class="muted"></div></div>
          <div class="actions">
            <button id="likeBtn" class="heart">♡</button>
            <span id="likeCount" class="muted">0 like</span>
            <div style="flex:1"></div>
            <button id="deletePhotoBtn" class="btn danger" style="display:none">Elimina foto</button>
          </div>
          <div id="commentsList" class="comments"></div>
          <div class="newc">
            <input id="commentInput" placeholder="Aggiungi un commento…"/>
            <button id="sendComment" class="btn primary">Invia</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>
  <div id="errBox" class="error"></div>

  <script>
    // === Supabase init ===
    const SUPABASE_URL = "https://lkdtvaiwlnkxwvlimvqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = (s, r=document)=>r.querySelector(s);
    const showErr = (m)=>{const b=qs('#errBox');b.textContent=m;b.style.display='block';};
    const clearErr = ()=>{const b=qs('#errBox');b.textContent='';b.style.display='none';};
    const toast = (m,ms=1600)=>{const t=qs('#toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',ms);};

    let user = null;
    let chosenFiles = []; // upload batch
    let currentPhoto = null; // {id, user_id, image_path, caption}

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.href = 'auth.html?next=profile.html'; return; }
      user = session.user;

      qs('#meEmail').textContent = user.email;
      qs('#uidBadge').textContent = 'uid: ' + user.id;

      // Listeners header + mobile drawer
      qs('#logoutBtn').addEventListener('click', async () => { await supabase.auth.signOut(); location.href = 'auth.html'; });
      const hamburger = qs('#hamburger'); const overlay = qs('#mobileOverlay'); const drawer = qs('#mobileDrawer'); const closeBtn = qs('#closeDrawer');
      function openDrawer(){ overlay.classList.add('open'); drawer.classList.add('open'); hamburger.setAttribute('aria-expanded','true'); drawer.setAttribute('aria-hidden','false'); }
      function closeDrawer(){ overlay.classList.remove('open'); drawer.classList.remove('open'); hamburger.setAttribute('aria-expanded','false'); drawer.setAttribute('aria-hidden','true'); }
      hamburger.addEventListener('click', openDrawer); closeBtn.addEventListener('click', closeDrawer); overlay.addEventListener('click', closeDrawer);
      const logoutBtn2 = qs('#logoutBtn2'); if (logoutBtn2) logoutBtn2.addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='auth.html'; });

      // Toggle edit & form
      qs('#editToggle').addEventListener('click', toggleEdit);
      qs('#reloadBtn').addEventListener('click', loadProfile);
      qs('#saveBtn').addEventListener('click', onSave);
      qs('#removeAvatarBtn').addEventListener('click', onRemoveAvatar);
      qs('#avatarFile').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; qs('#avatarImg').src = URL.createObjectURL(f); });

      // Upload foto bacheca
      qs('#fabAdd').addEventListener('click', ()=> qs('#photoPicker').click());
      qs('#photoPicker').addEventListener('change', openUploadModal);
      qs('#cancelUpload').addEventListener('click', closeUploadModal);
      qs('#startUpload').addEventListener('click', startUpload);

      // Viewer listeners
      qs('#closeViewer').addEventListener('click', closeViewer);
      qs('#likeBtn').addEventListener('click', toggleLike);
      qs('#sendComment').addEventListener('click', sendComment);
      qs('#commentInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendComment(); }});

      await ensureProfileRow();
      await loadProfile();
      await loadGallery();
    })();

    function toggleEdit(){
      const p = qs('#editPanel');
      p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    async function ensureProfileRow() {
      const { data } = await supabase.from('profiles').select('id').eq('id', user.id).maybeSingle();
      if (!data) { await supabase.from('profiles').insert([{ id: user.id }]); }
    }

    async function loadProfile() {
      clearErr();
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name, location, age, bio, avatar_url')
        .eq('id', user.id)
        .maybeSingle();
      if (error) { showErr("Errore caricamento profilo: "+error.message); return; }

      const dn = data?.display_name || "Utente";
      const bio = data?.bio || "";
      theParts = [];
      const parts = [];
      if (data?.age) parts.push(`Età: ${data.age}`);
      if (data?.location) parts.push(`Località: ${data.location}`);

      qs('#display_name_txt').textContent = dn;
      qs('#bio_txt').textContent = bio;
      qs('#extra_txt').textContent = parts.join(' · ') || "";

      const avatarUrl = data?.avatar_url
        ? data.avatar_url + `?t=${Date.now()}`
        : 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 140"><rect width="140" height="140" fill="#0f0f12"/><circle cx="70" cy="56" r="30" fill="#1e1e24"/><rect x="24" y="92" width="92" height="30" rx="15" fill="#1e1e24"/></svg>`);
      qs('#avatarImg').src = avatarUrl;

      // precompila form
      qs('#display_name').value = data?.display_name ?? '';
      qs('#location').value     = data?.location ?? '';
      qs('#age').value          = data?.age ?? '';
      qs('#bio').value          = data?.bio ?? '';
    }

    // === SALVA (avatar + dati) e CHIUDE pannello ===
    async function onSave(){
      clearErr();
      const saveBtn = qs('#saveBtn'); saveBtn.disabled = true;
      const oldTxt = saveBtn.textContent; saveBtn.textContent = 'Salvo…';
      try {
        // 1) Upload avatar se presente
        let avatarUrlToSave = null;
        const file = qs('#avatarFile').files?.[0];
        if (file) {
          const safe = file.name.replace(/\s+/g,'_');
          const path = `${user.id}/${Date.now()}_${safe}`;
          const up = await supabase.storage.from('avatars').upload(path, file, { upsert:false });
          if (up.error) throw up.error;
          const pub = supabase.storage.from('avatars').getPublicUrl(path);
          avatarUrlToSave = pub.data?.publicUrl || null;
        }

        // 2) Upsert profilo
        const payload = {
          id: user.id,
          display_name: qs('#display_name').value.trim() || null,
          location: qs('#location').value.trim() || null,
          age: qs('#age').value ? Number(qs('#age').value) : null,
          bio: qs('#bio').value.trim() || null
        };
        if (avatarUrlToSave) payload.avatar_url = avatarUrlToSave;

        const { error } = await supabase.from('profiles').upsert(payload, { onConflict:'id' });
        if (error) throw error;

        if (avatarUrlToSave) {
          qs('#avatarImg').src = avatarUrlToSave + `?t=${Date.now()}`;
          qs('#avatarFile').value = '';
        }
        toggleEdit();
        toast('Profilo aggiornato');
        await loadProfile();
      } catch (err) {
        showErr("Errore salvataggio: " + (err?.message || err));
      } finally {
        saveBtn.textContent = oldTxt;
        saveBtn.disabled = false;
      }
    }

    async function onRemoveAvatar(){
      clearErr();
      const { error } = await supabase.from('profiles').update({ avatar_url:null }).eq('id', user.id);
      if (error){ showErr("Rimozione avatar: "+error.message); return; }
      await loadProfile(); toast('Avatar rimosso');
    }

    // ======= GALLERIA =======
    async function loadGallery(){
      const grid = qs('#gallery'); const empty = qs('#empty');
      grid.innerHTML = ''; empty.style.display='none';

      const { data, error } = await supabase
        .from('user_photos')
        .select('id, user_id, image_path, caption, created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false });
      if (error){ showErr("Lettura galleria: "+error.message); return; }
      if (!data || !data.length){ empty.style.display='block'; return; }

      for (const ph of data){
        const tile = document.createElement('div'); tile.className='tile';
        tile.innerHTML = `
          <img src="${ph.image_path}" alt="photo"/>
          <button class="btn danger del" style="position:absolute;top:6px;right:6px">Elimina</button>
          ${ph.caption ? `<div class="cap">${ph.caption}</div>` : ``}
        `;
        tile.querySelector('img').addEventListener('click', ()=> openViewer(ph));
        tile.querySelector('.del').addEventListener('click', (e)=>{ e.stopPropagation(); deletePhoto(ph.id, ph.image_path, tile); });
        grid.appendChild(tile);
      }
    }

    // ======= VIEWER =======
    function openViewer(photo){
      currentPhoto = photo;
      qs('#viewImg').src = photo.image_path;
      qs('#viewCaption').textContent = photo.caption || '';
      qs('#viewOwner').textContent = qs('#display_name_txt').textContent || 'Profilo';
      qs('#deletePhotoBtn').style.display = (photo.user_id === user.id) ? 'inline-flex' : 'none';
      qs('#viewer').style.display = 'block';
      refreshViewer();
    }
    function closeViewer(){
      currentPhoto = null;
      qs('#viewer').style.display = 'none';
      qs('#commentsList').innerHTML = '';
      qs('#commentInput').value = '';
    }

    async function refreshViewer(){
      if (!currentPhoto) return;
      const pid = currentPhoto.id;

      // conteggio like
      const likeCountQ = await supabase.from('photo_likes').select('id', { head:true, count:'exact' }).eq('photo_id', pid);
      const countLikes = likeCountQ?.count ?? 0;
      qs('#likeCount').textContent = `${countLikes} like`;

      // liked by me?
      const likedQ = await supabase.from('photo_likes').select('id').eq('photo_id', pid).eq('user_id', user.id).maybeSingle();
      const liked = !!likedQ.data;
      const heart = qs('#likeBtn');
      heart.classList.toggle('liked', liked);
      heart.textContent = liked ? '♥' : '♡';

      // commenti (supporta sia body che content)
      const { data: comments, error } = await supabase
        .from('photo_comments')
        .select('id, body, content, created_at, user_id')
        .eq('photo_id', pid)
        .order('created_at', { ascending:true });
      if (error){ showErr("Lettura commenti: "+error.message); return; }

      // profili autori
      const ids = [...new Set(comments.map(c=>c.user_id))];
      let profMap = {};
      if (ids.length){
        const { data: profs } = await supabase.from('profiles').select('id, display_name, avatar_url').in('id', ids);
        (profs||[]).forEach(p=> profMap[p.id] = p);
      }

      const list = qs('#commentsList'); list.innerHTML='';
      comments.forEach(c=>{
        const p = profMap[c.user_id] || {};
        const name = p.display_name || 'Utente';
        const av = p.avatar_url || '';
        const text = c.body || c.content || '';
        const wrap = document.createElement('div'); wrap.className='comment';
        wrap.innerHTML = `
          <div class="by">
            <div class="leftby">
              ${av ? `<img src="${av}" style="width:18px;height:18px;border-radius:50%;vertical-align:middle;margin-right:6px"/>` : ``}
              <strong>${name}</strong> · ${new Date(c.created_at).toLocaleString()}
            </div>
            ${c.user_id===user.id ? `<button data-id="${c.id}" class="btn danger sm delc">Elimina</button>` : ``}
          </div>
          <div class="text">${escapeHtml(text)}</div>
        `;
        if (c.user_id===user.id){
          const delBtn = wrap.querySelector('.delc');
          if (delBtn) delBtn.addEventListener('click', ()=> deleteComment(c.id));
        }
        list.appendChild(wrap);
      });
    }

    async function toggleLike(){
      if (!currentPhoto) return;
      const pid = currentPhoto.id;
      const { data: existing } = await supabase.from('photo_likes').select('id').eq('photo_id', pid).eq('user_id', user.id).maybeSingle();
      if (existing){
        await supabase.from('photo_likes').delete().eq('id', existing.id);
      }else{
        await supabase.from('photo_likes').insert([{ photo_id: pid, user_id: user.id }]);
      }
      refreshViewer();
    }

    // >>> INVIO COMMENTO: inserisce body e content (compatibilità con schema esistente)
    async function sendComment(){
      if (!currentPhoto) return;
      const input = qs('#commentInput');
      const body = (input.value||'').trim();
      if (!body) return;
      const { error } = await supabase.from('photo_comments')
        .insert([{ photo_id: currentPhoto.id, user_id: user.id, body, content: body }]);
      if (error){ showErr("Invio commento: " + error.message); return; }
      input.value = '';
      refreshViewer();
    }

    async function deleteComment(cid){
      const { error } = await supabase.from('photo_comments').delete().eq('id', cid);
      if (error){ showErr("Elimina commento: "+error.message); return; }
      refreshViewer();
    }

    qs('#deletePhotoBtn').addEventListener('click', async ()=>{
      if (!currentPhoto) return;
      await deletePhoto(currentPhoto.id, currentPhoto.image_path);
      closeViewer();
      await loadGallery();
    });

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    // ======= MODALE UPLOAD (caption + progress) =======
    function openUploadModal(e){
      chosenFiles = [];
      const files = e.target.files;
      if (!files || !files.length) return;

      const list = qs('#uploadList'); list.innerHTML = '';
      for (const f of files){
        const url = URL.createObjectURL(f);
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `
          <img src="${url}" alt="preview"/>
          <div>
            <input placeholder="Didascalia (facoltativa)"/>
            <div class="bar" style="margin-top:8px"><span></span></div>
          </div>`;
        list.appendChild(row);
        chosenFiles.push({
          file: f,
          captionInput: row.querySelector('input'),
          progressEl: row.querySelector('.bar span')
        });
      }
      qs('#overlay').style.display = 'flex';
    }
    function closeUploadModal(){
      qs('#overlay').style.display = 'none';
      qs('#photoPicker').value = '';
      chosenFiles = [];
    }

    async function startUpload(){
      clearErr();
      if (!chosenFiles.length) { closeUploadModal(); return; }
      for (const item of chosenFiles){
        item.progressEl.style.width = '25%';
        const f = item.file;
        const safe = f.name.replace(/\s+/g,'_');
        const path = `${user.id}/${Date.now()}_${safe}`;

        const { error: upErr } = await supabase.storage.from('user-media').upload(path, f, { upsert:false });
        if (upErr){ item.progressEl.style.width='0%'; showErr("Upload foto: "+upErr.message); return; }

        item.progressEl.style.width = '60%';
        const { data: pub } = supabase.storage.from('user-media').getPublicUrl(path);
        const publicUrl = pub?.publicUrl;

        const caption = (item.captionInput.value || '').trim() || null;
        const { error: dbErr } = await supabase.from('user_photos').insert([{ user_id: user.id, image_path: publicUrl, caption }]);
        if (dbErr){ item.progressEl.style.width='0%'; showErr("Salvataggio DB foto: "+dbErr.message); return; }

        item.progressEl.style.width = '100%';
      }
      toast('Foto pubblicate');
      closeUploadModal();
      await loadGallery();
    }

    async function deletePhoto(photoId, imageUrl, tileEl){
      try{
        const u = new URL(imageUrl);
        const parts = u.pathname.split('/');
        const idx = parts.indexOf('user-media');
        const rel = parts.slice(idx+1).join('/'); // <uid>/file.jpg
        const { error: del1 } = await supabase.storage.from('user-media').remove([ rel ]);
        if (del1) console.warn('Delete storage:', del1);
      }catch(e){ console.warn('Parse URL storage fallita'); }
      const { error: del2 } = await supabase.from('user_photos').delete().eq('id', photoId);
      if (del2){ showErr("Eliminazione record: "+del2.message); return; }
      if (tileEl) tileEl.remove();
      toast('Foto eliminata');
    }
  </script>
</body>
</html>
