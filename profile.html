<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GeoChat • Il mio profilo</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0b0c;--card:#141417;--fg:#f6f6f7;--muted:#8a8a94;--brand:#ff8a00;--border:#232328}
    *{box-sizing:border-box} body{margin:0;background:#0b0b0c;color:var(--fg);font-family:system-ui,Segoe UI,Inter,Roboto,Arial}
    header{position:sticky;top:0;background:#0b0b0cdd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;justify-content:space-between}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#16161a;color:var(--fg);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#ff8a00,#ffb347);color:#1a1a1a;font-weight:700;border:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:16px}
    h1{margin:12px 0 8px} .muted{color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field input,.field textarea{background:#0f0f12;border:1px solid var(--border);color:var(--fg);border-radius:12px;padding:12px}
    .hint{font-size:12px;color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#101014;border:1px solid var(--border)}
    .toast{position:fixed;right:18px;bottom:18px;background:#141417;border:1px solid var(--border);padding:12px 14px;border-radius:12px;display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="row">
        <strong>GeoChat</strong>
        <span id="meEmail" class="badge">…</span>
      </div>
      <div class="row">
        <a class="btn" href="index.html">Home</a>
        <a class="btn" href="join.html">Entra</a>
        <a class="btn" href="chat.html">Chat</a>
        <a class="btn" href="settings.html">Impostazioni</a>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1>Il mio profilo</h1>
    <p class="muted">Aggiorna i tuoi dati. (Avatar e bacheca foto li aggiungiamo nello step successivo.)</p>

    <section class="card">
      <form id="profileForm">
        <div class="field">
          <label for="display_name">Nome visualizzato</label>
          <input id="display_name" placeholder="Es. Carmine" />
        </div>
        <div class="field">
          <label for="location">Di dove sei</label>
          <input id="location" placeholder="Es. Napoli (IT)" />
        </div>
        <div class="field">
          <label for="age">Età</label>
          <input id="age" type="number" min="0" max="120" placeholder="Es. 30" />
        </div>
        <div class="field">
          <label for="bio">Bio</label>
          <textarea id="bio" rows="4" placeholder="Scrivi qualcosa su di te…"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button type="submit" class="btn primary">Salva modifiche</button>
          <button type="button" id="reloadBtn" class="btn">Ricarica</button>
          <a id="publicLink" class="btn" target="_blank" href="#">Vedi profilo pubblico</a>
        </div>
        <p class="hint">I dati sono salvati in <code>public.profiles</code>. (RLS abilitate.)</p>
      </form>
    </section>
  </main>

  <div id="toast" class="toast">Salvato!</div>

  <script>
    // === Supabase init ===
    const SUPABASE_URL = "https://lkdtvaiwlnkxwvlimvqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = (s, r=document)=>r.querySelector(s);
    const toast = (msg, ms=1600) => {
      const t = qs('#toast'); t.textContent = msg; t.style.display='block';
      setTimeout(()=> t.style.display='none', ms);
    };

    let user = null;

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        location.href = 'auth.html?next=profile.html';
        return;
      }
      user = session.user;
      qs('#meEmail').textContent = user.email;
      qs('#publicLink').href = `user.html?uid=${user.id}`;

      qs('#logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        location.href = 'auth.html';
      });
      qs('#reloadBtn').addEventListener('click', loadProfile);
      qs('#profileForm').addEventListener('submit', onSave);

      await ensureProfileRow();
      await loadProfile();
    })();

    async function ensureProfileRow() {
      // Crea riga profilo vuota se non esiste
      const { data, error } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .maybeSingle();

      if (error) {
        console.error(error);
        toast('Errore profilo');
        return;
      }
      if (!data) {
        const { error: insErr } = await supabase
          .from('profiles')
          .insert([{ id: user.id }]);
        if (insErr) console.error(insErr);
      }
    }

    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name, location, age, bio')
        .eq('id', user.id)
        .maybeSingle();
      if (error) {
        console.error(error);
        return toast('Errore nel caricamento');
      }
      qs('#display_name').value = data?.display_name ?? '';
      qs('#location').value     = data?.location ?? '';
      qs('#age').value          = data?.age ?? '';
      qs('#bio').value          = data?.bio ?? '';
    }

    async function onSave(e) {
      e.preventDefault();
      const payload = {
        id: user.id,
        display_name: qs('#display_name').value.trim() || null,
        location: qs('#location').value.trim() || null,
        age: qs('#age').value ? Number(qs('#age').value) : null,
        bio: qs('#bio').value.trim() || null
      };
      const { error } = await supabase
        .from('profiles')
        .upsert(payload, { onConflict: 'id' });
      if (error) {
        console.error(error);
        toast('Errore salvataggio');
      } else {
        toast('Profilo aggiornato');
        await loadProfile();
      }
    }
  </script>
</body>
</html>
