<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeoChat ‚Ä¢ Crea chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--g1:#0f0f10;--g2:#1a1a1c;--acc1:#ff8a00;--acc2:#ffb233;}
    body{background:linear-gradient(180deg,var(--g1),var(--g2));color:#eaeaea;}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .btn-main{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#111;font-weight:700}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    #map{height:420px}
  </style>
  <!-- Google Maps -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZZD33JtcrbvN-THBixRMhPdvc9m8tT9s&libraries=places,geometry,drawing&callback=initMap">
  </script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="w-full py-4 px-5 flex items-center justify-between">
  <div class="flex items-center gap-2">
    <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-black">GC</div>
    <div class="font-extrabold text-xl">GeoChat</div>
  </div>
  <nav class="flex items-center gap-3 text-sm">
    <a href="index.html" class="chip px-3 py-1.5 rounded-lg">Home</a>
    <a href="create.html" class="btn-main px-3 py-1.5 rounded-lg">Crea la tua chat</a>
    <a href="admin.html" class="chip px-3 py-1.5 rounded-lg">Admin</a>
    <a id="authLink" href="auth.html" class="chip px-3 py-1.5 rounded-lg">Entra</a>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 pb-24 grid md:grid-cols-3 gap-6">
  <section class="md:col-span-2 glass rounded-2xl p-5">
    <h2 class="text-lg font-bold mb-3">1) Cerca indirizzo/attivit√† & disegna il perimetro</h2>

    <div class="flex gap-2 mb-3">
      <input id="placeInput" class="flex-1 chip rounded-lg px-3 py-2" placeholder="Via/locale (es. Pizzeria Da Mario)" />
      <button id="btnSearch" class="chip rounded-lg px-4">Cerca</button>
    </div>

    <div class="flex gap-2 mb-3">
      <button id="drawBtn" class="chip px-3 py-1.5 rounded-lg">‚úèÔ∏è Disegna</button>
      <button id="editBtn" class="chip px-3 py-1.5 rounded-lg">‚úÇÔ∏è Modifica</button>
      <button id="clearBtn" class="chip px-3 py-1.5 rounded-lg">üóëÔ∏è Elimina</button>
    </div>

    <div id="map" class="rounded-xl overflow-hidden"></div>
    <p class="mt-2 text-xs opacity-70">Disegna un <b>poligono</b> intorno al locale. Per rimuovere un vertice: click destro su quel punto.</p>
  </section>

  <aside class="glass rounded-2xl p-5">
    <h2 class="text-lg font-bold mb-3">2) Dettagli & link/QR</h2>

    <label class="text-sm block mb-1 opacity-80">Descrizione (opzionale)</label>
    <textarea id="desc" class="w-full chip rounded-lg p-3 h-28 mb-3"
      placeholder="Es. Chat del Bar Centrale solo per chi √® dentro il locale"></textarea>

    <button id="createBtn" class="btn-main w-full rounded-lg py-2.5">Crea chat & genera QR</button>

    <div id="qrWrap" class="hidden mt-5 text-center">
      <h3 class="font-bold mb-2">QR della stanza</h3>
      <img id="qrImg" class="inline-block rounded-lg" alt="QR" />
      <div class="mt-2 text-xs break-all opacity-80" id="roomLink"></div>
    </div>
  </aside>
</main>

<script>
  // ---- CONFIG
  const SUPABASE_URL = 'https://lkdtvaiwlnkxwvlimvqs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrZHR2YWl3bG5reHd2bGltdnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3OTE4MDMsImV4cCI6MjA3MzM2NzgwM30.3onrM-EBuDJuNa27_XI6LFqMwUHI9qecvLxrOElM3P8';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // auth link
  (async ()=>{
    const { data: { session } } = await sb.auth.getSession();
    const link = document.getElementById('authLink');
    if (session){
      link.textContent = 'Esci';
      link.onclick = async (e)=>{ e.preventDefault(); await sb.auth.signOut(); location.href='index.html'; }
    } else {
      link.textContent = 'Entra';
      link.href = 'auth.html';
    }
  })();

  let map, marker, drawingManager, polygon=null, searchBox;

  window.initMap = function(){
    map = new google.maps.Map(document.getElementById('map'),{
      center:{lat:41.9028,lng:12.4964}, zoom:14, streetViewControl:false, mapTypeControl:true
    });

    // Disegno
    drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: null,
      drawingControl:false,
      polygonOptions: { editable:true, fillColor:'#00ff80', fillOpacity:.25, strokeColor:'#00ff80' }
    });
    drawingManager.setMap(map);
    google.maps.event.addListener(drawingManager,'polygoncomplete',poly=>{
      if (polygon) polygon.setMap(null);
      polygon = poly;
    });

    // Cerca
    const input = document.getElementById('placeInput');
    const ac = new google.maps.places.Autocomplete(input);
    ac.addListener('place_changed',()=>{
      const place = ac.getPlace();
      if (!place.geometry) return;
      map.panTo(place.geometry.location);
      map.setZoom(18);
      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({position:place.geometry.location, map, animation:'DROP'});
    });
    document.getElementById('btnSearch').onclick = ()=> google.maps.event.trigger(ac,'place_changed');

    // toolbar
    document.getElementById('drawBtn').onclick = ()=> drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
    document.getElementById('editBtn').onclick = ()=> { if (polygon) polygon.setEditable(true); }
    document.getElementById('clearBtn').onclick = ()=> { if (polygon){ polygon.setMap(null); polygon=null; } if (marker){ marker.setMap(null); marker=null; } };
  }

  // Crea stanza
  document.getElementById('createBtn').onclick = async ()=>{
    if (!polygon){ alert('Disegna prima il perimetro.'); return; }

    // centro
    const bounds = new google.maps.LatLngBounds();
    polygon.getPath().forEach(p=>bounds.extend(p));
    const center = bounds.getCenter();

    // geojson
    const coords = [];
    polygon.getPath().forEach(p=> coords.push([p.lng(), p.lat()]) );
    if (coords.length && (coords[0][0]!==coords.at(-1)[0] || coords[0][1]!==coords.at(-1)[1])) coords.push(coords[0]);
    const geojson = { type:'Polygon', coordinates:[coords] };

    // indirizzo dal marker o dal centro
    let address = '';
    const geocoder = new google.maps.Geocoder();
    const latlng = marker ? marker.getPosition() : center;
    try{
      const res = await geocoder.geocode({location:latlng});
      address = res?.results?.[0]?.formatted_address || '';
    }catch{}

    // nome automatico se non specificato
    const name = document.getElementById('placeInput').value.trim() || 'Chat locale';

    const { data, error } = await sb.from('rooms').insert({
      id: crypto.randomUUID().slice(0,8),
      name,
      description: document.getElementById('desc').value.trim(),
      address,
      polygon: geojson,
      center_lat: center.lat(),
      center_lng: center.lng()
    }).select('id').single();

    if (error){ console.error(error); alert('Impossibile creare la chat.'); return; }

    const link = `${location.origin}/join.html?room=${encodeURIComponent(data.id)}`;

    // QR rapido via servizio
    document.getElementById('roomLink').textContent = link;
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(link)}`;
    const img = document.getElementById('qrImg'); img.src = qr; img.alt = 'QR stanza';
    document.getElementById('qrWrap').classList.remove('hidden');

    alert('Stanza creata! Scannerizza il QR o apri il link per il check-in.');
  };
</script>
</body>
</html>
